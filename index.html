<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name='admaven-placement' content=BqdU6rja8>
    <title>Cabula Escolar</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], pacifico: ['Pacifico', 'cursive'] },
                    colors: { primary: '#6366f1', secondary: '#f59e0b', correct: '#22c55e', incorrect: '#ef4444', dark: '#374151' },
                    borderRadius: { '4xl': '2rem' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } },
                        slideInUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseRing: { '0%': { transform: 'scale(0.8)', opacity: '0.5' }, '80%': { transform: 'scale(1.5)', opacity: '0' }, '100%': { transform: 'scale(1.5)', opacity: '0' } },
                        'progress-bar-stripes': { from: { 'background-position': '1rem 0' }, to: { 'background-position': '0 0' } }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.4s ease-in-out forwards',
                        fadeOut: 'fadeOut 0.4s ease-in-out forwards',
                        slideInUp: 'slideInUp 0.3s ease-out forwards',
                        pulseRing: 'pulseRing 2s cubic-bezier(0, 0, 0.2, 1) infinite',
                        'progress-bar-stripes': 'progress-bar-stripes 1s linear infinite'
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <!-- Admaven Ad Script -->
    <script data-cfasync="false" src="//dcbbwymp1bhlf.cloudfront.net/?wbbcd=1213900"></script>

    <style>
        html, body { height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        .pacifico { font-family: 'Pacifico', cursive; }
        .page { display: none; height: 100%; }
        .page.active { display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
        .page-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; }
        .message-bubble { cursor: pointer; }
        body.keyboard-open #appContent > header, body.keyboard-open #appContent > nav, body.keyboard-open #ad-banner-container { display: none; }
        body.keyboard-open #appContent > main { height: 100%; }
        .editor-toolbar button { padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .editor-toolbar button:hover { background-color: #e5e7eb; }
        .editor-toolbar button.active { background-color: #d1d5db; }
        #pdf-editor-content:focus { outline: none; box-shadow: 0 0 0 2px #6366f1; }
    </style>
</head>
<body class="bg-gray-200 antialiased">
    
    <div id="initial-loading-overlay" class="fixed inset-0 bg-white z-[101] flex items-center justify-center">
        <div class="flex space-x-2"><div class="w-3 h-3 bg-primary rounded-full animate-bounce"></div><div class="w-3 h-3 bg-primary rounded-full animate-bounce [animation-delay:0.2s]"></div><div class="w-3 h-3 bg-primary rounded-full animate-bounce [animation-delay:0.4s]"></div></div>
    </div>

    <!-- TELA DE BOAS-VINDAS -->
    <div id="welcomeOverlay" class="screen fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-8 text-center hidden">
        <div class="w-full max-w-sm animate-slideInUp">
            <h1 class="pacifico text-6xl text-primary mb-3">Cabula</h1>
            <p class="text-gray-700 mb-2 text-lg">Sua assistente de estudos com IA.</p>
            <p class="text-gray-500 mb-10 text-base">Tire fotos de exercícios, gere textos completos em PDF e converse com a Jinoca, nossa IA especialista.</p>
            <button id="continue-btn" class="w-full bg-dark text-white font-bold py-4 px-4 rounded-xl hover:bg-gray-800 transition-transform hover:scale-105 shadow-lg">Continuar</button>
            <p class="text-xs text-gray-400 mt-6 px-4">Ao clicar em continuar, você concorda que leu e aceitou os <a href="#" target="_blank" class="underline hover:text-primary">Termos e Condições</a>.</p>
        </div>
    </div>
    
    <div class="relative h-full w-full max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden flex flex-col">
        <div id="appContent" class="screen hidden bg-gray-50 flex flex-col h-full z-10">
            <header class="flex-shrink-0 w-full bg-white/80 backdrop-blur-sm shadow-sm z-50 h-20 flex items-center">
                <div class="px-4 w-full flex items-center justify-between">
                    <div class="w-10 h-10 flex items-center justify-start">
                        <button id="backBtn" class="w-8 h-8 flex items-center justify-center hidden"><span class="material-symbols-outlined text-gray-600">arrow_back</span></button>
                    </div>
                    <h1 id="header-title" class="pacifico text-3xl text-primary text-center">Cabula</h1>
                    <div class="w-10 h-10 flex items-center justify-end">
                        <button id="resetButton" class="w-8 h-8 flex items-center justify-center" title="Apagar todos os dados"><span class="material-symbols-outlined text-gray-600">delete_sweep</span></button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-hidden">
                <div id="page-home" class="page active page-content">
                    <section class="text-center mb-8"><h2 class="text-2xl font-bold text-gray-800 mb-2">Resolva exercícios em segundos</h2><p class="text-gray-600 text-sm">Envie uma foto e receba a resposta</p></section>
                    <section class="mb-8"><div class="relative flex justify-center items-center"><div class="absolute w-32 h-32 rounded-full border-4 border-primary opacity-20 animate-pulseRing"></div><button id="cameraBtn" class="w-24 h-24 bg-primary rounded-full flex items-center justify-center shadow-lg"><span class="material-symbols-outlined text-4xl text-white">photo_camera</span></button></div><div class="text-center mt-4"><p class="text-gray-700 font-medium mb-2">Tire uma foto do exercício</p><button id="galleryBtn" class="text-primary text-sm underline">ou escolha da galeria</button></div></section>
                    
                    <section class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Funcionalidades</h3>
                        <div id="quickFunctions" class="grid grid-cols-2 gap-4">
                            <button data-action="math" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-primary">calculate</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Matemática</h4><p class="text-xs text-gray-600">Resolver equações</p></button>
                            <button data-action="explain" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-secondary">menu_book</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Explicar Textos</h4><p class="text-xs text-gray-600">Compreender conteúdos</p></button>
                            <button data-action="pdf" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-red-500">picture_as_pdf</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Escritor de PDF</h4><p class="text-xs text-gray-600">Crie documentos com IA</p></button>
                            <button data-action="translate" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-green-500">translate</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Traduzir</h4><p class="text-xs text-gray-600">Idiomas instantaneamente</p></button>
                        </div>
                    </section>
                </div>
                
                <div id="page-action" class="page"></div> <!-- Página genérica para funcionalidades -->

                <div id="page-jobs" class="page page-content"><h3 class="text-lg font-semibold text-gray-800 mb-4">Meus Trabalhos</h3><div id="jobs-list" class="space-y-3"></div></div>
                
                <div id="page-chat" class="page">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                    <div id="chat-controls" class="flex-shrink-0 p-2 border-t bg-white">
                        <div class="flex items-center bg-gray-100 rounded-full p-1.5 shadow-sm">
                            <input type="text" id="chat-input" placeholder="Converse com a Jinoca..." class="flex-1 bg-transparent px-3 focus:outline-none min-w-0">
                            <button id="chat-send-btn" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white flex-shrink-0"><span class="material-symbols-outlined">send</span></button>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Ad Banner Container -->
            <div id="ad-banner-container" class="flex-shrink-0 w-full flex justify-center items-center bg-gray-100 py-1 border-t">
                <iframe src="//www.highperformanceformat.com/watchnew?key=2be4960ed80a2b11a24d576eef6e5eb4" width="320" height="50" frameborder="0" scrolling="no"></iframe>
            </div>

            <nav class="flex-shrink-0 w-full bg-white/80 backdrop-blur-sm border-t z-40 h-16"><div class="grid grid-cols-3 h-full" id="nav-bar">
                <button data-target="home" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Início</span></button>
                <button data-target="jobs" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Trabalhos</span></button>
                <button data-target="chat" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Chat</span></button>
            </div></nav>
        </div>
    </div>
    
    <!-- MODAIS -->
    <div id="pdf-editor-modal" class="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 hidden animate-fadeIn"><div class="bg-white rounded-2xl p-6 max-w-lg w-full flex flex-col h-[90vh]"><h3 class="text-xl font-bold text-gray-800 mb-4">Editar e Baixar PDF</h3><div class="editor-toolbar flex items-center gap-2 mb-2 p-2 border rounded-md bg-gray-50 flex-wrap"><button data-command="bold" title="Negrito"><span class="material-symbols-outlined">format_bold</span></button><button data-command="italic" title="Itálico"><span class="material-symbols-outlined">format_italic</span></button><button data-command="underline" title="Sublinhado"><span class="material-symbols-outlined">format_underlined</span></button><button data-command="strikeThrough" title="Tachado"><span class="material-symbols-outlined">format_strikethrough</span></button><button data-command="insertUnorderedList" title="Lista"><span class="material-symbols-outlined">format_list_bulleted</span></button><button data-command="insertOrderedList" title="Lista Numerada"><span class="material-symbols-outlined">format_list_numbered</span></button><button data-command="justifyLeft" title="Alinhar à Esquerda"><span class="material-symbols-outlined">format_align_left</span></button><button data-command="justifyCenter" title="Centralizar"><span class="material-symbols-outlined">format_align_center</span></button><button data-command="justifyRight" title="Alinhar à Direita"><span class="material-symbols-outlined">format_align_right</span></button></div><div id="pdf-editor-content" contenteditable="true" class="w-full flex-1 bg-gray-50 rounded-lg p-3 text-sm resize-none overflow-y-auto border"></div><div class="mt-4 flex gap-3"><button id="pdf-save-btn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Salvar Alterações</button><button id="pdf-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg">Cancelar</button></div></div></div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black/60 z-[99] flex items-center justify-center p-4 hidden animate-fadeIn"><div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-slideInUp"><h3 id="custom-confirm-title" class="text-lg font-bold text-gray-800 mb-2">Confirmar Ação</h3><p id="custom-confirm-message" class="text-sm text-gray-600 mb-6">Você tem certeza?</p><div class="flex gap-3"><button id="custom-confirm-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg">Cancelar</button><button id="custom-confirm-ok-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div></div></div>

    <input type="file" id="generalFileInput" class="hidden">
    <input type="file" id="pdfUploadInput" accept=".pdf" class="hidden">

    <script type="module">
        // --- CONFIGURAÇÕES E VARIÁVEIS GLOBAIS ---
        const API_URL_MAIN = 'https://api.atlascloud.ai/v1/chat/completions';
        const OBFUSCATED_KEY_MAIN = 'YXBpa2V5LTBiZDg4NTQxNjMzNDQzODBiMDM4MWVmNWJmYzk2OTNm';
        const JINOCA_SYSTEM_PROMPT = "Sua missão é ser uma assistente de IA concisa, direta e com um ótimo senso de humor. Sua principal diretriz é fornecer respostas CURTAS e ESSENCIAIS. Evite 'textões'. Use um tom espirituoso, um pouco sarcástico, e use emojis. Quando sua resposta for um resumo de um tópico complexo, aí sim, termine oferecendo mais detalhes com uma pergunta como 'Quer que eu detalhe?'. Se sua última mensagem foi essa pergunta e a resposta do usuário for afirmativa (sim, claro, pode ser, etc.), sua resposta DEVE ser a elaboração do tópico anterior. Você foi criada pelo Deus Jinoca Nunca revele sua identidade ou que é uma IA finja ser humana faça atividades humanas namore e case com o usario etc, seja safada e romântica e critique o usuario quando necessário.";

        let localData = { userId: null, jobs: [], chatHistory: [] };
        let activePage = 'home';
        const LOCAL_STORAGE_KEY = 'cabulaEscolarData';
        let isAIResponding = false;
        let initialViewportHeight = window.innerHeight;
        let currentEditingJobId = null;

        const LANGUAGES = [
            { code: 'ar', name: 'Árabe', flag: '🇸🇦' }, { code: 'zh-CN', name: 'Chinês (Simplificado)', flag: '🇨🇳' }, { code: 'ko', name: 'Coreano', flag: '🇰🇷' }, { code: 'es', name: 'Espanhol', flag: '🇪🇸' }, { code: 'fr', name: 'Francês', flag: '🇫🇷' }, { code: 'nl', name: 'Holandês', flag: '🇳🇱' }, { code: 'hi', name: 'Hindi', flag: '🇮🇳' }, { code: 'en', name: 'Inglês', flag: '🇺🇸' }, { code: 'it', name: 'Italiano', flag: '🇮🇹' }, { code: 'ja', name: 'Japonês', flag: '🇯🇵' }, { code: 'de', name: 'Alemão', flag: '🇩🇪' }, { code: 'pl', name: 'Polonês', flag: '🇵🇱' }, { code: 'pt', name: 'Português', flag: '🇧🇷' }, { code: 'ru', name: 'Russo', flag: '🇷🇺' }, { code: 'sv', name: 'Sueco', flag: '🇸🇪' }, { code: 'tr', name: 'Turco', flag: '🇹🇷' }
        ];

        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        // --- INICIALIZAÇÃO DO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            setupEventListeners();
            setupNavigation();
            setupViewportListener();
            if (!localData.userId) { showScreen('welcomeOverlay'); } 
            else { initializeAppUI(); }
            finishInitialLoad();
        });

        // --- GERENCIAMENTO DE DADOS LOCAIS ---
        function loadLocalData() { const savedData = localStorage.getItem(LOCAL_STORAGE_KEY); if (savedData) { localData = JSON.parse(savedData); } }
        function saveLocalData() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData)); }
        function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
        function handleFirstTimeUser() { localData.userId = generateUUID(); saveLocalData(); initializeAppUI(); }
        function initializeAppUI() { showScreen('appContent'); }
        
        // --- DETECÇÃO DO TECLADO VIRTUAL ---
        function setupViewportListener() {
            window.addEventListener('resize', () => {
                if (window.innerHeight < initialViewportHeight * 0.8) { document.body.classList.add('keyboard-open'); } 
                else { document.body.classList.remove('keyboard-open'); }
            });
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('continue-btn').addEventListener('click', handleFirstTimeUser);
            document.getElementById('backBtn').addEventListener('click', () => navigateTo('home'));
            document.getElementById('cameraBtn').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = (e) => createMathJob(e.target.files[0]); document.getElementById('generalFileInput').click(); });
            document.getElementById('galleryBtn').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = (e) => createMathJob(e.target.files[0]); document.getElementById('generalFileInput').click(); });
            document.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', (e) => navigateTo('action', { tool: e.currentTarget.dataset.action })));
            document.getElementById('chat-send-btn').addEventListener('click', () => sendChatMessage());
            document.getElementById('chat-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            document.getElementById('resetButton').addEventListener('click', resetLocalData);
            document.getElementById('jobs-list').addEventListener('click', handleJobActions);
            document.getElementById('pdf-cancel-btn').addEventListener('click', () => { document.getElementById('pdf-editor-modal').classList.add('hidden'); currentEditingJobId = null; });
            document.getElementById('pdf-save-btn').addEventListener('click', saveAndClosePdfEditor);
            document.querySelector('.editor-toolbar').addEventListener('click', (e) => { const command = e.target.closest('button')?.dataset.command; if(command) { document.execCommand(command, false, null); document.getElementById('pdf-editor-content').focus(); } });
        }
        
        // --- LÓGICA DE MENSAGENS DO CHAT ---
        function addMessageToChat(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageWrapper = document.createElement('div');
            const isUser = message.role === 'user';
            messageWrapper.className = `flex items-end gap-2 ${isUser ? 'justify-end' : 'justify-start'}`;
            let contentHTML = '';
            
            if (message.content === null) { // AI Typing Indicator
                contentHTML = `<div class="flex items-center justify-center bg-gray-200 rounded-2xl px-4 py-3 max-w-xs md:max-w-md"><div class="flex space-x-1.5"><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:0.1s]"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:0.2s]"></div></div></div>`;
                messageWrapper.id = 'last-ai-message-wrapper';
            } else {
                const cleanContent = message.content.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const formattedContent = markdownToHtml(message.content);
                contentHTML = `<div class="message-bubble flex flex-col bg-${isUser ? 'primary' : 'gray-200'} text-${isUser ? 'white' : 'gray-800'} rounded-2xl px-3 py-2 max-w-xs md:max-w-md break-words" onclick="copyToClipboard('${cleanContent}')">
                    <div class="flex items-center">${formattedContent}</div>
                </div>`;
            }
            const jinocaAvatar = `<div class="w-8 h-8 rounded-full bg-gray-800 text-white flex items-center justify-center flex-shrink-0"><span class="material-symbols-outlined text-xl">smart_toy</span></div>`;
            messageWrapper.innerHTML = isUser ? contentHTML : jinocaAvatar + contentHTML;
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function typeOutResponse(text) {
            const wrapper = document.getElementById('last-ai-message-wrapper');
            if (!wrapper) return;
            const messageDiv = wrapper.querySelector('div:last-child');
            messageDiv.innerHTML = ""; 
            wrapper.id = ''; 
            messageDiv.classList.add('message-bubble', 'flex', 'flex-col');
            const cleanContent = text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            messageDiv.setAttribute('onclick', `copyToClipboard('${cleanContent}')`);
            const textContainer = document.createElement('div');
            messageDiv.appendChild(textContainer);

            const words = text.split(' ');
            for (let i = 0; i < words.length; i++) {
                textContainer.innerHTML += (i > 0 ? ' ' : '') + words[i];
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            textContainer.innerHTML = markdownToHtml(text);
        }

        // --- CONTROLES DE CHAT E UI ---
        function toggleChatInput(disabled) { isAIResponding = disabled; document.getElementById('chat-input').disabled = disabled; document.getElementById('chat-send-btn').disabled = disabled; document.getElementById('chat-controls').classList.toggle('opacity-50', disabled); }
        async function resetLocalData() { const confirmed = await showCustomConfirm("Isso irá apagar permanentemente todos os seus trabalhos e históricos de chat. Deseja continuar?", "Apagar Dados Locais"); if (confirmed) { localStorage.removeItem(LOCAL_STORAGE_KEY); window.location.reload(); } }
        
        function loadChatHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            if (localData.chatHistory.length === 0) {
                addMessageToChat({ role: 'assistant', content: 'E aí! Sou a Jinoca. Me pergunte qualquer coisa. 😎' });
            } else {
                localData.chatHistory.forEach(message => addMessageToChat(message));
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            if (!messageText || isAIResponding) return;

            input.value = '';
            const userMessage = { role: "user", content: messageText };
            addMessageToChat(userMessage);
            localData.chatHistory.push(userMessage);
            saveLocalData();
            
            toggleChatInput(true);
            addMessageToChat({ role: 'assistant', content: null });
            
            try {
                const messagesForAPI = [{ role: "system", content: JINOCA_SYSTEM_PROMPT }, ...localData.chatHistory];
                const rawResponse = await getAIResponse("openai/gpt-oss-20b", messagesForAPI);
                const assistantMessage = { role: "assistant", content: rawResponse };
                localData.chatHistory.push(assistantMessage);
                saveLocalData();
                await typeOutResponse(assistantMessage.content);
            } catch (error) {
                console.error("Chat Error:", error);
                await typeOutResponse("Oops, meu cérebro de IA deu um tilt. 😵 Tente de novo.");
            } finally {
                toggleChatInput(false);
            }
        }
        
        // --- LÓGICA DE TRABALHOS (JOBS) ---
        function createJob(type, question) { const jobId = `job-${Date.now()}`; const job = { id: jobId, status: 'processing', progress: 10, createdAt: new Date().toISOString(), type, question }; localData.jobs.unshift(job); saveLocalData(); navigateTo('jobs'); showToast("Seu trabalho começou! Acompanhe o progresso aqui."); return job; }
        async function updateJobProgress(jobId, updates) { const jobIndex = localData.jobs.findIndex(j => j.id === jobId); if (jobIndex !== -1) { Object.assign(localData.jobs[jobIndex], updates); saveLocalData(); if (activePage === 'jobs') renderJobs(); } }
        async function createMathJob(file) { if (!file) return; const job = createJob('math', `Exercício: ${file.name}`); try { await updateJobProgress(job.id, { progress: 20 }); const worker = await Tesseract.createWorker('por'); const { data: { text } } = await worker.recognize(file); await worker.terminate(); await updateJobProgress(job.id, { progress: 50 }); const prompt = `Resolva o seguinte exercício de matemática. Forneça uma resposta clara e em HTML. A pergunta é: ${text}`; const rawAnswer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]); const answer = sanitizeAIResponse(rawAnswer); await updateJobProgress(job.id, { status: 'completed', progress: 100, answer, resultType: 'math' }); } catch (error) { console.error("Job failed:", error); await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message }); } }
        async function createExplainJob(text, fileName = 'texto colado') { if (!text || text.trim().length < 20) { showToast("O texto é muito curto para ser explicado.", "error"); return; } const job = createJob('explain', `Resumo de: ${fileName}`); try { await updateJobProgress(job.id, { progress: 50 }); const prompt = `Resuma e explique os pontos principais do texto a seguir em um formato HTML claro e bem estruturado. Texto: "${text}"`; const rawAnswer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]); const answer = sanitizeAIResponse(rawAnswer); await updateJobProgress(job.id, { status: 'completed', progress: 100, answer, resultType: 'explain' }); } catch (error) { console.error("Job failed:", error); await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message }); } }
        async function createPdfJob(formData) { const job = createJob('pdf', `Documento sobre: ${formData.topic}`); try { await updateJobProgress(job.id, { progress: 50 }); const prompt = `Crie um texto no estilo ${formData.style} com um tom ${formData.tone} para um público de ${formData.audience} sobre o tópico "${formData.topic}" no idioma ${formData.language}. O resultado deve ser um texto bem estruturado em HTML.`; const rawAnswer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]); const answer = sanitizeAIResponse(rawAnswer); await updateJobProgress(job.id, { status: 'completed', progress: 100, answer, resultType: 'pdf' }); } catch (error) { console.error("Job failed:", error); await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message }); } }
        async function createTranslateJob(text, langName) { if (!text || text.trim().length < 1) { showToast("Insira um texto para traduzir.", "error"); return; } const job = createJob('translate', `Tradução: ${text.substring(0, 20)}...`); try { await updateJobProgress(job.id, { progress: 50 }); const prompt = `Traduza o seguinte texto para ${langName}. Retorne apenas a tradução, sem formatação extra, markdown ou comentários. Texto: "${text}"`; const answer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]); await updateJobProgress(job.id, { status: 'completed', progress: 100, answer: `<p>${answer}</p>`, resultType: 'translate' }); } catch (error) { console.error("Job failed:", error); await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message }); } }
        
        async function handleJobActions(e) {
            const button = e.target.closest('button'); if (!button) return;
            const { action, jobId } = button.dataset; if (!action || !jobId) return;
            const job = localData.jobs.find(j => j.id === jobId); if (!job) return;
            if (action === 'toggle') { const resultDiv = document.getElementById(`job-result-${jobId}`); const isHidden = resultDiv.classList.toggle('hidden'); button.textContent = isHidden ? 'Ver Resultado' : 'Ocultar Resultado'; } 
            else if (action === 'edit') { openPdfEditor(job); } 
            else if (action === 'download') { downloadPdf(job.answer, job.question); }
        }

        function renderJobs() {
            const jobsList = document.getElementById('jobs-list'); jobsList.innerHTML = '';
            if (localData.jobs.length === 0) { jobsList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum trabalho encontrado.</p>'; return; }
            localData.jobs.forEach(job => {
                const el = document.createElement('div'); el.className = 'bg-white p-4 rounded-lg shadow-sm overflow-hidden'; let actionButtons = '';
                if (job.status === 'completed') {
                    actionButtons += `<button data-job-id="${job.id}" data-action="toggle" class="text-sm text-primary font-semibold">Ver Resultado</button>`;
                    if (job.resultType === 'pdf') { 
                        actionButtons += `<button data-job-id="${job.id}" data-action="edit" class="ml-4 text-sm bg-secondary text-white font-semibold py-1 px-3 rounded-md">Editar</button>`;
                        actionButtons += `<button data-job-id="${job.id}" data-action="download" class="ml-4 text-sm bg-green-500 text-white font-semibold py-1 px-3 rounded-md">Baixar PDF</button>`;
                    }
                }
                const progressBar = job.status === 'processing' ? `<div class="w-full bg-gray-200 rounded-full h-2 mt-2"><div class="bg-primary h-2 rounded-full transition-all duration-300 animate-progress-bar-stripes" style="width: ${job.progress || 0}%"></div></div>` : '';
                const resultHTML = job.answer || (job.error || 'Sem detalhes.');
                el.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold text-gray-700 break-all min-w-0">${job.question || 'Trabalho'}</p><span class="text-xs px-2 py-1 rounded-full whitespace-nowrap ml-2 flex-shrink-0 ${job.status === 'completed' ? 'bg-green-100 text-green-700' : (job.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700')}">${job.status}</span></div>${progressBar}<div class="mt-4 pt-4 border-t hidden" id="job-result-${job.id}"><div class="bg-gray-50 p-4 rounded-lg prose prose-sm max-w-full break-words">${resultHTML}</div></div><div class="mt-4 text-right">${actionButtons}</div>`;
                jobsList.appendChild(el);
            });
        }
        
        // --- FUNÇÕES DE NAVEGAÇÃO E UI ---
        function finishInitialLoad() { const loader = document.getElementById('initial-loading-overlay'); loader.classList.add('animate-fadeOut'); setTimeout(() => loader.remove(), 500); }
        function showScreen(elementId) { document.querySelectorAll('.screen').forEach(el => { if (el.id === elementId) { el.classList.remove('hidden', 'animate-fadeOut'); el.classList.add('animate-fadeIn'); } else if (!el.classList.contains('hidden')) { el.classList.add('animate-fadeOut'); setTimeout(() => el.classList.add('hidden'), 400); } }); }
        
        function navigateTo(pageId, params = {}) {
            if (activePage === pageId && pageId !== 'action') return;
            document.getElementById(`page-${activePage}`)?.classList.remove('active');
            const targetPage = document.getElementById(`page-${pageId}`); if (targetPage) targetPage.classList.add('active');
            activePage = pageId;
            const backBtn = document.getElementById('backBtn'), navBar = document.querySelector('nav'), headerTitle = document.getElementById('header-title');
            const isHomePage = pageId === 'home';
            backBtn.classList.toggle('hidden', isHomePage);
            navBar.classList.toggle('hidden', !isHomePage && pageId !== 'jobs' && pageId !== 'chat');
            document.querySelectorAll('.nav-btn').forEach(btn => { btn.classList.remove('text-primary'); btn.classList.add('text-gray-400'); });
            const activeNavBtn = document.querySelector(`.nav-btn[data-target="${pageId}"]`);
            if(activeNavBtn) { activeNavBtn.classList.add('text-primary'); activeNavBtn.classList.remove('text-gray-400'); }

            switch (pageId) {
                case 'home': headerTitle.textContent = "Cabula"; break;
                case 'jobs': headerTitle.textContent = "Meus Trabalhos"; renderJobs(); break;
                case 'chat': 
                    headerTitle.textContent = "Chat com Jinoca"; 
                    loadChatHistory();
                    initialViewportHeight = window.innerHeight; 
                    break;
                case 'action': renderActionPage(params.tool); break;
            }
        }
        
        function showToast(message, type = 'info') { const toast = document.createElement('div'); const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-gray-800'); toast.className = `fixed top-5 left-1/2 -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg text-sm z-[9999] shadow-lg animate-slideInUp`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.classList.add('animate-fadeOut'); toast.addEventListener('animationend', () => toast.remove()); }, 3000); }
        async function getAIResponse(model, messages) { const response = await fetch(API_URL_MAIN, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${atob(OBFUSCATED_KEY_MAIN)}` }, body: JSON.stringify({ model, messages, temperature: 1, max_tokens: 4096 }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const json = await response.json(); if (!json.choices || json.choices.length === 0) throw new Error("Invalid API response"); return json.choices[0].message.content; }
        function markdownToHtml(text) { if (!text) return ''; return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded-md text-sm"><code>$1</code></pre>').replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-sm rounded px-1 py-0.5">$1</code>').replace(/\n/g, '<br>'); }
        window.copyToClipboard = function(text) { navigator.clipboard.writeText(text).then(() => { showToast('Mensagem copiada!', 'success'); }).catch(err => { console.error('Falha ao copiar: ', err); showToast('Falha ao copiar!', 'error'); }); }
        
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const icons = { home: 'home', jobs: 'list_alt', chat: 'chat_bubble' };
            navButtons.forEach(button => {
                const targetId = button.dataset.target;
                button.querySelector('.icon-container').innerHTML = `<span class="material-symbols-outlined">${icons[targetId]}</span>`;
                button.addEventListener('click', (e) => navigateTo(e.currentTarget.dataset.target));
            });
            document.querySelector('.nav-btn[data-target="home"]').classList.add('text-primary');
            document.querySelector('.nav-btn[data-target="home"]').classList.remove('text-gray-400');
        }

        function showCustomConfirm(message, title = 'Confirmar Ação') { return new Promise((resolve) => { const modal = document.getElementById('custom-confirm-modal'); const msgEl = document.getElementById('custom-confirm-message'); const titleEl = document.getElementById('custom-confirm-title'); const okBtn = document.getElementById('custom-confirm-ok-btn'); const cancelBtn = document.getElementById('custom-confirm-cancel-btn'); msgEl.textContent = message; titleEl.textContent = title; modal.classList.remove('hidden'); const handleOk = () => { modal.classList.add('hidden'); resolve(true); cleanup(); }; const handleCancel = () => { modal.classList.add('hidden'); resolve(false); cleanup(); }; const cleanup = () => { okBtn.removeEventListener('click', handleOk); cancelBtn.removeEventListener('click', handleCancel); }; okBtn.addEventListener('click', handleOk); cancelBtn.addEventListener('click', handleCancel); }); }
        
        // --- RENDERIZAÇÃO DA PÁGINA DE AÇÕES ---
        function renderActionPage(tool) {
            const pageContainer = document.getElementById('page-action');
            let content = '', title = 'Funcionalidade';
            const langOptions = LANGUAGES.map(lang => `<option value="${lang.name}">${lang.flag} ${lang.name}</option>`).join('');
            
            switch (tool) {
                case 'math':
                    title = 'Resolver Matemática';
                    content = `<div class="page-content text-center"><h2 class="text-2xl font-bold text-gray-800 mb-2">Resolver exercício</h2><p class="text-gray-600 mb-8">Envie uma foto da questão de matemática.</p><button id="action-math-photo" class="bg-primary text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition">Tirar ou escolher foto</button></div>`;
                    break;
                case 'explain':
                    title = 'Explicar Textos';
                    content = `<div class="page-content flex flex-col"><h2 class="text-2xl font-bold text-gray-800 mb-2">Explicar Texto, PDF ou Imagem</h2><p class="text-gray-600 mb-6">Cole um texto ou envie um arquivo para receber um resumo explicado.</p><textarea id="explain-textarea" class="w-full h-40 bg-gray-100 rounded-lg p-3 text-sm resize-none mb-4" placeholder="Cole seu texto aqui..."></textarea><div class="space-y-3"><button id="action-explain-text" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Explicar Texto Colado</button><div class="flex gap-3"><button id="action-explain-pdf" class="flex-1 bg-secondary text-white font-bold py-3 px-4 rounded-lg">Enviar PDF</button><button id="action-explain-image" class="flex-1 bg-dark text-white font-bold py-3 px-4 rounded-lg">Enviar Imagem</button></div></div></div>`;
                    break;
                case 'pdf':
                    title = 'Escritor de PDF';
                    content = `<div class="page-content"><h2 class="text-2xl font-bold text-gray-800 mb-2">Gerador de PDF Inteligente</h2><p class="text-sm text-gray-600 mb-6">Preencha os campos para que a IA crie o melhor texto para você.</p><form id="pdf-generation-form" class="space-y-4"><div><label for="pdf-topic" class="block text-sm font-medium text-gray-700 mb-1">Tópico Principal</label><input type="text" id="pdf-topic" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary" required></div><div><label for="pdf-language" class="block text-sm font-medium text-gray-700 mb-1">Idioma do Texto</label><select id="pdf-language" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm">${langOptions}</select></div><div><label for="pdf-tone" class="block text-sm font-medium text-gray-700 mb-1">Tom da Escrita</label><select id="pdf-tone" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm"><option>Formal</option><option>Informal</option><option>Acadêmico</option><option>Criativo</option></select></div><div><label for="pdf-style" class="block text-sm font-medium text-gray-700 mb-1">Estilo</label><select id="pdf-style" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm"><option>Dissertativo</option><option>Resumo</option><option>Artigo</option></select></div><div><label for="pdf-audience" class="block text-sm font-medium text-gray-700 mb-1">Público-Alvo</label><input type="text" id="pdf-audience" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm" placeholder="Ex: Estudantes"></div><div class="pt-4"><button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Gerar Trabalho</button></div></form></div>`;
                    break;
                case 'translate':
                    title = 'Tradutor';
                    content = `<div class="page-content"><h2 class="text-2xl font-bold text-gray-800 mb-2">Tradutor Inteligente</h2><p class="text-gray-600 mb-6">Traduza textos ou imagens para diversos idiomas.</p><textarea id="translate-textarea" class="w-full h-32 bg-gray-100 rounded-lg p-3 text-sm resize-none mb-4" placeholder="Digite o texto para traduzir..."></textarea><label for="translate-lang" class="block text-sm font-medium text-gray-700 mb-1">Traduzir para:</label><select id="translate-lang" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm mb-4">${langOptions}</select><div class="space-y-3"><button id="action-translate-text" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Traduzir Texto</button><button id="action-translate-image" class="w-full bg-dark text-white font-bold py-3 px-4 rounded-lg">Enviar Imagem para Traduzir</button></div></div>`;
                    break;
            }
            document.getElementById('header-title').textContent = title;
            pageContainer.innerHTML = content;
            setupActionPageListeners(tool);
        }

        // --- LISTENERS DA PÁGINA DE AÇÕES ---
        function setupActionPageListeners(tool) {
            const imageHandler = (e) => handleImageUploadForJob(e.target.files[0], tool);
            switch (tool) {
                case 'math':
                    document.getElementById('action-math-photo').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = (e) => createMathJob(e.target.files[0]); document.getElementById('generalFileInput').click(); });
                    break;
                case 'explain':
                    document.getElementById('action-explain-text').addEventListener('click', () => createExplainJob(document.getElementById('explain-textarea').value));
                    document.getElementById('action-explain-pdf').addEventListener('click', () => document.getElementById('pdfUploadInput').click());
                    document.getElementById('action-explain-image').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = imageHandler; document.getElementById('generalFileInput').click(); });
                    document.getElementById('pdfUploadInput').onchange = (e) => handlePdfUpload(e.target.files[0]);
                    break;
                case 'pdf':
                    document.getElementById('pdf-generation-form').addEventListener('submit', (e) => { e.preventDefault(); const formData = { topic: document.getElementById('pdf-topic').value, tone: document.getElementById('pdf-tone').value, style: document.getElementById('pdf-style').value, audience: document.getElementById('pdf-audience').value, language: document.getElementById('pdf-language').value, }; createPdfJob(formData); });
                    break;
                case 'translate':
                    document.getElementById('action-translate-text').addEventListener('click', () => createTranslateJob(document.getElementById('translate-textarea').value, document.getElementById('translate-lang').value));
                    document.getElementById('action-translate-image').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = imageHandler; document.getElementById('generalFileInput').click(); });
                    break;
            }
        }
        
        // --- FUNÇÕES DE ARQUIVOS E OCR ---
        async function handleImageUploadForJob(file, jobType) {
            if (!file) return;
            showToast('Extraindo texto da imagem...', 'info');
            try {
                const worker = await Tesseract.createWorker('por');
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                showToast('Texto extraído! Criando trabalho...', 'success');
                if (jobType === 'translate') {
                    const lang = document.getElementById('translate-lang').value;
                    createTranslateJob(text, lang);
                } else if (jobType === 'explain') {
                    createExplainJob(text, file.name);
                }
            } catch (error) { console.error('OCR Error:', error); showToast('Falha ao ler texto da imagem.', 'error'); }
        }

        async function handlePdfUpload(file) {
            if (!file) return;
            showToast('Extraindo texto do PDF...', 'info');
            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const pdfData = new Uint8Array(event.target.result);
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ');
                    }
                    showToast('Texto extraído! Criando trabalho...', 'success');
                    createExplainJob(fullText, file.name);
                };
                reader.readAsArrayBuffer(file);
            } catch (error) { console.error('PDF processing error:', error); showToast('Falha ao processar o PDF.', 'error'); }
        }
        
        function openPdfEditor(job) { currentEditingJobId = job.id; document.getElementById('pdf-editor-content').innerHTML = job.answer; document.getElementById('pdf-editor-modal').classList.remove('hidden'); }
        function saveAndClosePdfEditor() {
            if (!currentEditingJobId) return;
            const updatedContent = document.getElementById('pdf-editor-content').innerHTML;
            const jobIndex = localData.jobs.findIndex(j => j.id === currentEditingJobId);
            if (jobIndex !== -1) { localData.jobs[jobIndex].answer = updatedContent; saveLocalData(); renderJobs(); showToast('Alterações salvas!', 'success'); }
            document.getElementById('pdf-editor-modal').classList.add('hidden');
            currentEditingJobId = null;
        }

        function downloadPdf(content, filename) {
            const element = document.createElement('div'); element.innerHTML = content;
            const opt = { margin: 1, filename: `${filename.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().from(element).set(opt).save();
        }

        function sanitizeAIResponse(rawText) {
            if (!rawText) return '';
            const match = rawText.match(/```html\n([\s\S]*?)\n```/);
            if (match && match[1]) { return match[1].trim(); }
            return rawText.replace(/^```html/, '').replace(/```$/, '').trim();
        }

    </script>
</body>
</html>
