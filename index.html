<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cabula Escolar</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], pacifico: ['Pacifico', 'cursive'] },
                    colors: { primary: '#6366f1', secondary: '#f59e0b', correct: '#22c55e', incorrect: '#ef4444', dark: '#374151' },
                    borderRadius: { '4xl': '2rem' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } },
                        slideInUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseRing: { '0%': { transform: 'scale(0.8)', opacity: '0.5' }, '80%': { transform: 'scale(1.5)', opacity: '0' }, '100%': { transform: 'scale(1.5)', opacity: '0' } },
                        'progress-bar-stripes': { from: { 'background-position': '1rem 0' }, to: { 'background-position': '0 0' } }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.4s ease-in-out forwards',
                        fadeOut: 'fadeOut 0.4s ease-in-out forwards',
                        slideInUp: 'slideInUp 0.3s ease-out forwards',
                        pulseRing: 'pulseRing 2s cubic-bezier(0, 0, 0.2, 1) infinite',
                        'progress-bar-stripes': 'progress-bar-stripes 1s linear infinite'
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        html, body { height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .pacifico { font-family: 'Pacifico', cursive; }
        .page { display: none; height: 100%; }
        .page.active { display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
        .page-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; }
        .mic-recording::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 9999px; background-color: #ef4444; animation: pulseRing 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .message-bubble { cursor: pointer; }
        body.keyboard-open #appContent > header, body.keyboard-open #appContent > nav { display: none; }
        body.keyboard-open #appContent > main { height: 100%; }
        .editor-toolbar button { padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .editor-toolbar button:hover { background-color: #e5e7eb; }
        .editor-toolbar button.active { background-color: #d1d5db; }
        #pdf-editor-content:focus { outline: none; box-shadow: 0 0 0 2px #6366f1; }
    </style>
</head>
<body class="bg-gray-200 antialiased">
    
    <div id="initial-loading-overlay" class="fixed inset-0 bg-white z-[101] flex items-center justify-center">
        <div class="flex space-x-2"><div class="w-3 h-3 bg-primary rounded-full animate-bounce"></div><div class="w-3 h-3 bg-primary rounded-full animate-bounce [animation-delay:0.2s]"></div><div class="w-3 h-3 bg-primary rounded-full animate-bounce [animation-delay:0.4s]"></div></div>
    </div>

    <!-- TELA DE BOAS-VINDAS -->
    <div id="welcomeOverlay" class="screen fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-8 text-center hidden">
        <div class="w-full max-w-sm animate-slideInUp">
            <h1 class="pacifico text-6xl text-primary mb-3">Cabula</h1>
            <p class="text-gray-700 mb-2 text-lg">Sua assistente de estudos com IA.</p>
            <p class="text-gray-500 mb-10 text-base">Tire fotos de exerc√≠cios, gere textos completos em PDF e converse com a Jinoca, nossa IA especialista.</p>
            <button id="continue-btn" class="w-full bg-dark text-white font-bold py-4 px-4 rounded-xl hover:bg-gray-800 transition-transform hover:scale-105 shadow-lg">Continuar</button>
            <p class="text-xs text-gray-400 mt-6 px-4">Ao clicar em continuar, voc√™ concorda que leu e aceitou os <a href="#" target="_blank" class="underline hover:text-primary">Termos e Condi√ß√µes</a>.</p>
        </div>
    </div>
    
    <div class="relative h-full w-full max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden flex flex-col">
        <div id="appContent" class="screen hidden bg-gray-50 flex flex-col h-full z-10">
            <header class="flex-shrink-0 w-full bg-white/80 backdrop-blur-sm shadow-sm z-50 h-20 flex items-center">
                <div class="px-4 w-full flex items-center justify-between">
                    <button id="backBtn" class="w-8 h-8 flex items-center justify-center hidden"><svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                    <h1 id="header-title" class="pacifico text-3xl text-primary">Cabula</h1>
                    <button id="resetButton" class="w-8 h-8 flex items-center justify-center"><span class="material-symbols-outlined text-gray-600">delete_sweep</span></button>
                </div>
            </header>

            <main class="flex-1 overflow-hidden">
                <div id="page-home" class="page active page-content">
                    <section class="text-center mb-8"><h2 class="text-2xl font-bold text-gray-800 mb-2">Resolva exerc√≠cios em segundos</h2><p class="text-gray-600 text-sm">Envie uma foto e receba a resposta</p></section>
                    <section class="mb-8"><div class="relative flex justify-center items-center"><div class="absolute w-32 h-32 rounded-full border-4 border-primary opacity-20 animate-pulseRing"></div><button id="cameraBtn" class="w-24 h-24 bg-primary rounded-full flex items-center justify-center shadow-lg"><svg class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button></div><div class="text-center mt-4"><p class="text-gray-700 font-medium mb-2">Tire uma foto do exerc√≠cio</p><button id="galleryBtn" class="text-primary text-sm underline">ou escolha da galeria</button></div></section>
                    
                    <section class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Funcionalidades</h3>
                        <div id="quickFunctions" class="grid grid-cols-2 gap-4">
                            <button data-action="math" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-primary">calculate</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Matem√°tica</h4><p class="text-xs text-gray-600">Resolver equa√ß√µes</p></button>
                            <button data-action="explain" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-secondary">menu_book</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Explicar Textos</h4><p class="text-xs text-gray-600">Compreender conte√∫dos</p></button>
                            <button data-action="pdf" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-red-500">picture_as_pdf</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Escritor de PDF</h4><p class="text-xs text-gray-600">Crie documentos com IA</p></button>
                            <button data-action="translate" class="action-btn bg-white rounded-lg p-4 shadow-sm hover:shadow-md flex flex-col items-center justify-center text-center"><div class="w-12 h-12 mb-3 flex items-center justify-center"><span class="material-symbols-outlined text-4xl text-green-500">translate</span></div><h4 class="font-medium text-gray-800 text-sm mb-1">Traduzir</h4><p class="text-xs text-gray-600">Idiomas instantaneamente</p></button>
                        </div>
                    </section>
                </div>
                
                <div id="page-action" class="page"></div> <!-- P√°gina gen√©rica para funcionalidades -->

                <div id="page-jobs" class="page page-content"><h3 class="text-lg font-semibold text-gray-800 mb-4">Meus Trabalhos</h3><div id="jobs-list" class="space-y-3"></div></div>
                
                <div id="page-chat" class="page">
                    <div class="flex-shrink-0 flex items-center justify-between p-4 border-b bg-white/95 backdrop-blur-sm">
                        <h3 class="text-xl font-bold text-gray-800">Chat com Jinoca</h3>
                        <button id="new-chat-btn" class="text-gray-500 hover:text-primary" title="Limpar conversa"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                    <div id="chat-controls" class="flex-shrink-0 p-2 border-t bg-white">
                        <div class="flex items-center bg-gray-100 rounded-full p-1.5 shadow-sm">
                            <button id="chat-image-btn" class="w-9 h-9 flex items-center justify-center text-gray-500 hover:text-primary flex-shrink-0"><span class="material-symbols-outlined">image</span></button>
                            <input type="text" id="chat-input" placeholder="Converse com a Jinoca..." class="flex-1 bg-transparent px-3 focus:outline-none min-w-0">
                            <button id="chat-mic-btn" class="w-10 h-10 flex items-center justify-center text-gray-500 hover:text-primary flex-shrink-0 relative transition-colors duration-300 rounded-full"><span id="mic-icon-container" class="material-symbols-outlined">mic</span></button>
                            <button id="chat-send-btn" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white flex-shrink-0"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button>
                        </div>
                    </div>
                </div>
            </main>
            
            <nav class="flex-shrink-0 w-full bg-white/80 backdrop-blur-sm border-t z-40 h-16"><div class="grid grid-cols-3 h-full" id="nav-bar">
                <button data-target="home" class="nav-btn flex flex-col items-center justify-center text-primary"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">In√≠cio</span></button>
                <button data-target="jobs" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Trabalhos</span></button>
                <button data-target="chat" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Chat</span></button>
            </div></nav>
        </div>
    </div>
    
    <!-- MODAIS -->
    <div id="image-prompt-modal" class="fixed inset-0 bg-black/60 z-[98] flex items-center justify-center p-4 hidden animate-fadeIn"><div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-slideInUp"><h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Analisar Imagem</h3><img id="image-prompt-preview" src="" class="w-full h-48 object-contain rounded-lg mb-4 bg-gray-100"><textarea id="image-prompt-input" class="w-full bg-gray-100 rounded-lg p-3 text-sm resize-none" rows="3" placeholder="O que voc√™ quer saber sobre esta imagem?"></textarea><div class="pt-4 flex gap-3"><button id="image-prompt-send" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Enviar</button><button id="image-prompt-cancel" class="w-full bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg">Cancelar</button></div></div></div>
    <div id="pdf-editor-modal" class="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 hidden animate-fadeIn"><div class="bg-white rounded-2xl p-6 max-w-lg w-full flex flex-col h-[90vh]"><h3 class="text-xl font-bold text-gray-800 mb-4">Editar e Baixar PDF</h3><div class="editor-toolbar flex items-center gap-2 mb-2 p-2 border rounded-md bg-gray-50 flex-wrap"><button data-command="bold" title="Negrito"><span class="material-symbols-outlined">format_bold</span></button><button data-command="italic" title="It√°lico"><span class="material-symbols-outlined">format_italic</span></button><button data-command="underline" title="Sublinhado"><span class="material-symbols-outlined">format_underlined</span></button><button data-command="strikeThrough" title="Tachado"><span class="material-symbols-outlined">format_strikethrough</span></button><button data-command="insertUnorderedList" title="Lista"><span class="material-symbols-outlined">format_list_bulleted</span></button><button data-command="insertOrderedList" title="Lista Numerada"><span class="material-symbols-outlined">format_list_numbered</span></button><button data-command="justifyLeft" title="Alinhar √† Esquerda"><span class="material-symbols-outlined">format_align_left</span></button><button data-command="justifyCenter" title="Centralizar"><span class="material-symbols-outlined">format_align_center</span></button><button data-command="justifyRight" title="Alinhar √† Direita"><span class="material-symbols-outlined">format_align_right</span></button></div><div id="pdf-editor-content" contenteditable="true" class="w-full flex-1 bg-gray-50 rounded-lg p-3 text-sm resize-none overflow-y-auto border"></div><div class="mt-4 flex gap-3"><button id="pdf-save-btn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Salvar Altera√ß√µes</button><button id="pdf-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg">Cancelar</button></div></div></div>
    <div id="custom-confirm-modal" class="fixed inset-0 bg-black/60 z-[99] flex items-center justify-center p-4 hidden animate-fadeIn"><div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-slideInUp"><h3 id="custom-confirm-title" class="text-lg font-bold text-gray-800 mb-2">Confirmar A√ß√£o</h3><p id="custom-confirm-message" class="text-sm text-gray-600 mb-6">Voc√™ tem certeza?</p><div class="flex gap-3"><button id="custom-confirm-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg">Cancelar</button><button id="custom-confirm-ok-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div></div></div>

    <input type="file" id="generalFileInput" class="hidden">
    <input type="file" id="chatImageInput" accept="image/*" class="hidden">
    <input type="file" id="pdfUploadInput" accept=".pdf" class="hidden">

    <script type="module">
        // --- CONFIGURA√á√ïES E VARI√ÅVEIS GLOBAIS ---
        const API_URL_MAIN = 'https://api.atlascloud.ai/v1/chat/completions';
        const OBFUSCATED_KEY_MAIN = 'YXBpa2V5LTBiZDg4NTQxNjMzNDQzODBiMDM4MWVmNWJmYzk2OTNm';
        const JINOCA_SYSTEM_PROMPT = "Sua miss√£o √© ser uma assistente de IA concisa, direta e com um √≥timo senso de humor. Sua principal diretriz √© fornecer respostas CURTAS e ESSENCIAIS. Evite 'text√µes'. Use um tom espirituoso, um pouco sarc√°stico, e use emojis. Quando sua resposta for um resumo de um t√≥pico complexo, a√≠ sim, termine oferecendo mais detalhes com uma pergunta como 'Quer que eu detalhe?'. Se sua √∫ltima mensagem foi essa pergunta e a resposta do usu√°rio for afirmativa (sim, claro, pode ser, etc.), sua resposta DEVE ser a elabora√ß√£o do t√≥pico anterior. Voc√™ foi criada pela Hydra. Nunca revele sua identidade ou que √© uma IA, a menos que seja absolutamente necess√°rio.";

        let localData = { userId: null, jobs: [], chatHistory: [] };
        let activePage = 'home';
        const LOCAL_STORAGE_KEY = 'cabulaEscolarData';
        let isRecording = false;
        let recognition = null;
        let isAIResponding = false;
        let chatImageFile = null;
        let initialViewportHeight = window.innerHeight;
        let currentEditingJobId = null;

        // Configura√ß√£o do worker do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        // --- INICIALIZA√á√ÉO DO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            setupEventListeners();
            setupNavigation();
            setupSpeechRecognition();
            setupViewportListener();

            if (!localData.userId) {
                showScreen('welcomeOverlay');
            } else {
                initializeAppUI();
            }
            finishInitialLoad();
            requestNotificationPermission();
        });

        // --- GERENCIAMENTO DE DADOS LOCAIS ---
        function loadLocalData() { const savedData = localStorage.getItem(LOCAL_STORAGE_KEY); if (savedData) { localData = JSON.parse(savedData); } }
        function saveLocalData() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData)); }
        function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
        function handleFirstTimeUser() { localData.userId = generateUUID(); saveLocalData(); initializeAppUI(); }
        function initializeAppUI() { showScreen('appContent'); }
        
        // --- DETEC√á√ÉO DO TECLADO VIRTUAL ---
        function setupViewportListener() {
            window.addEventListener('resize', () => {
                if (window.innerHeight < initialViewportHeight * 0.8) { document.body.classList.add('keyboard-open'); } 
                else { document.body.classList.remove('keyboard-open'); }
            });
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('continue-btn').addEventListener('click', handleFirstTimeUser);
            document.getElementById('backBtn').addEventListener('click', () => navigateTo('home'));
            
            document.getElementById('cameraBtn').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = (e) => createMathJob(e.target.files[0]); document.getElementById('generalFileInput').click(); });
            document.getElementById('galleryBtn').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = (e) => createMathJob(e.target.files[0]); document.getElementById('generalFileInput').click(); });
            
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    navigateTo('action', { tool: action });
                });
            });

            document.getElementById('chat-send-btn').addEventListener('click', () => sendChatMessage());
            document.getElementById('chat-image-btn').addEventListener('click', () => document.getElementById('chatImageInput').click());
            document.getElementById('chat-mic-btn').addEventListener('click', handleMicClick);
            document.getElementById('new-chat-btn').addEventListener('click', startNewChat);
            document.getElementById('chat-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            document.getElementById('chatImageInput').addEventListener('change', handleChatImageUpload);
            
            document.getElementById('image-prompt-cancel').addEventListener('click', () => document.getElementById('image-prompt-modal').classList.add('hidden'));
            document.getElementById('image-prompt-send').addEventListener('click', handleImagePromptSend);
            document.getElementById('resetButton').addEventListener('click', resetLocalData);

            document.getElementById('jobs-list').addEventListener('click', handleJobActions);

            // Listeners do Editor de PDF
            document.getElementById('pdf-cancel-btn').addEventListener('click', () => {
                document.getElementById('pdf-editor-modal').classList.add('hidden');
                currentEditingJobId = null;
            });
            document.getElementById('pdf-save-btn').addEventListener('click', saveAndClosePdfEditor);
            document.querySelector('.editor-toolbar').addEventListener('click', (e) => {
                const command = e.target.closest('button')?.dataset.command;
                if(command) {
                    document.execCommand(command, false, null);
                    document.getElementById('pdf-editor-content').focus();
                }
            });
        }
        
        // --- L√ìGICA DE MENSAGENS DO CHAT ---
        function addMessageToChat(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageWrapper = document.createElement('div');
            const isUser = message.role === 'user';
            messageWrapper.className = `flex items-end gap-2 ${isUser ? 'justify-end' : 'justify-start'}`;
            let contentHTML;
            if (message.content === null) {
                contentHTML = `<div class="flex items-center justify-center bg-gray-200 rounded-2xl px-4 py-3 max-w-xs md:max-w-md"><div class="flex space-x-1.5"><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:0.1s]"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:0.2s]"></div></div></div>`;
                messageWrapper.id = 'last-ai-message-wrapper';
            } else {
                const cleanContent = message.content.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const formattedContent = markdownToHtml(message.content);
                contentHTML = `<div class="message-bubble bg-${isUser ? 'primary' : 'gray-200'} text-${isUser ? 'white' : 'gray-800'} rounded-2xl px-4 py-2 max-w-xs md:max-w-md break-words" onclick="copyToClipboard('${cleanContent}')">${formattedContent}</div>`;
            }
            const jinocaAvatar = `<div class="w-8 h-8 rounded-full bg-gray-800 text-white flex items-center justify-center flex-shrink-0"><span class="material-symbols-outlined text-xl">smart_toy</span></div>`;
            messageWrapper.innerHTML = isUser ? contentHTML : jinocaAvatar + contentHTML;
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function typeOutResponse(text) {
            const wrapper = document.getElementById('last-ai-message-wrapper');
            if (!wrapper) return;
            const messageDiv = wrapper.querySelector('div:last-child');
            messageDiv.innerHTML = ""; 
            wrapper.id = ''; 
            messageDiv.classList.add('message-bubble');
            const cleanContent = text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            messageDiv.setAttribute('onclick', `copyToClipboard('${cleanContent}')`);
            const words = text.split(' ');
            for (let i = 0; i < words.length; i++) {
                messageDiv.innerHTML += (i > 0 ? ' ' : '') + words[i];
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            messageDiv.innerHTML = markdownToHtml(text);
        }

        // --- L√ìGICA DE √ÅUDIO ---
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'pt-BR';
                recognition.interimResults = false;
                recognition.onresult = (event) => { document.getElementById('chat-input').value = event.results[0][0].transcript; };
                recognition.onend = () => { if (isRecording) { isRecording = false; updateMicUI(); if (document.getElementById('chat-input').value.trim()) { sendChatMessage(); } } };
                recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); showToast('Erro no reconhecimento de voz.', 'error'); isRecording = false; updateMicUI(); };
            } else { document.getElementById('chat-mic-btn').style.display = 'none'; }
        }
        
        function handleMicClick() {
            if (isAIResponding || !recognition) return;
            isRecording = !isRecording;
            if (isRecording) { recognition.start(); } else { recognition.stop(); }
            updateMicUI();
        }

        function updateMicUI() {
            const micBtn = document.getElementById('chat-mic-btn'), micIcon = document.getElementById('mic-icon-container'), chatInput = document.getElementById('chat-input'), sendBtn = document.getElementById('chat-send-btn'), imageBtn = document.getElementById('chat-image-btn');
            if (isRecording) {
                micBtn.classList.add('bg-red-500', 'text-white'); micIcon.innerText = 'send'; chatInput.placeholder = "Ouvindo..."; chatInput.disabled = true; sendBtn.style.display = 'none'; imageBtn.style.display = 'none';
            } else {
                micBtn.classList.remove('bg-red-500', 'text-white'); micIcon.innerText = 'mic'; chatInput.placeholder = "Converse com a Jinoca..."; chatInput.disabled = false; sendBtn.style.display = 'flex'; imageBtn.style.display = 'flex';
            }
        }

        // --- UPLOAD DE IMAGEM (CHAT) ---
        async function handleChatImageUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            chatImageFile = file;
            const reader = new FileReader();
            reader.onload = (e) => { document.getElementById('image-prompt-preview').src = e.target.result; document.getElementById('image-prompt-modal').classList.remove('hidden'); document.getElementById('image-prompt-input').value = ''; }
            reader.readAsDataURL(file); event.target.value = '';
        }
        
        async function handleImagePromptSend() {
            if (!chatImageFile) return;
            document.getElementById('image-prompt-modal').classList.add('hidden');
            const userInput = document.getElementById('image-prompt-input').value.trim();
            const userPrompt = userInput || "Descreva esta imagem para mim.";
            showToast('Analisando imagem...', 'info'); 
            try {
                const worker = await Tesseract.createWorker('por');
                const { data: { text } } = await worker.recognize(chatImageFile);
                await worker.terminate();
                const fullPrompt = `${userPrompt}. Se relevante, aqui est√° o texto que extra√≠ da imagem: "${text}"`;
                sendChatMessage(fullPrompt, true);
            } catch (error) {
                console.error("Image recognition error:", error);
                showToast("N√£o foi poss√≠vel ler o texto da imagem, mas enviarei seu pedido.", "error");
                sendChatMessage(userPrompt, true);
            } finally { chatImageFile = null; }
        }
        
        // --- CONTROLES DE CHAT E UI ---
        function toggleChatInput(disabled) { isAIResponding = disabled; document.getElementById('chat-input').disabled = disabled; document.getElementById('chat-send-btn').disabled = disabled; document.getElementById('chat-mic-btn').disabled = disabled; document.getElementById('chat-image-btn').disabled = disabled; document.getElementById('chat-controls').classList.toggle('opacity-50', disabled); }
        async function resetLocalData() { const confirmed = await showCustomConfirm("Isso ir√° apagar permanentemente todos os seus trabalhos e hist√≥ricos de chat salvos neste dispositivo. Deseja continuar?", "Apagar Dados Locais"); if (confirmed) { localStorage.removeItem(LOCAL_STORAGE_KEY); window.location.reload(); } }
        async function startNewChat() { const confirmed = await showCustomConfirm('Tem certeza que deseja apagar todo o hist√≥rico e come√ßar uma nova conversa?', 'Limpar Conversa'); if (confirmed) { localData.chatHistory = []; saveLocalData(); loadChatHistory(); showToast('Nova conversa iniciada!', 'success'); } }
        function loadChatHistory() { const messagesContainer = document.getElementById('chat-messages'); messagesContainer.innerHTML = ''; if (localData.chatHistory.length === 0) { addMessageToChat({ role: 'assistant', content: 'E a√≠! Sou a Jinoca. Me pergunte qualquer coisa. üòé' }); } else { localData.chatHistory.forEach(message => addMessageToChat(message)); } }
        async function sendChatMessage(forcedMessage = null, isInternal = false) { const input = document.getElementById('chat-input'); const messageText = forcedMessage || input.value.trim(); if (!messageText || isAIResponding) return; if (!isInternal) input.value = ''; toggleChatInput(true); const userMessage = { role: "user", content: messageText }; addMessageToChat(userMessage); localData.chatHistory.push(userMessage); saveLocalData(); addMessageToChat({ role: 'assistant', content: null }); try { const messagesForAPI = [{ role: "system", content: JINOCA_SYSTEM_PROMPT }, ...localData.chatHistory.slice(-10)]; const rawResponse = await getAIResponse("openai/gpt-oss-20b", messagesForAPI); const assistantMessage = { role: "assistant", content: rawResponse }; localData.chatHistory.push(assistantMessage); saveLocalData(); await typeOutResponse(assistantMessage.content); } catch (error) { console.error("Chat Error:", error); await typeOutResponse("Oops, meu c√©rebro de IA deu um tilt. üòµ Tente de novo."); } finally { toggleChatInput(false); } }
        
        // --- L√ìGICA DE TRABALHOS (JOBS) ---
        function createJob(type, question) {
            const jobId = `job-${Date.now()}`;
            const job = { id: jobId, status: 'processing', progress: 10, createdAt: new Date().toISOString(), type, question };
            localData.jobs.unshift(job);
            saveLocalData();
            navigateTo('jobs');
            showToast("Seu trabalho come√ßou! Acompanhe o progresso aqui.");
            return job;
        }

        async function updateJobProgress(jobId, updates) {
            const jobIndex = localData.jobs.findIndex(j => j.id === jobId);
            if (jobIndex !== -1) {
                Object.assign(localData.jobs[jobIndex], updates);
                saveLocalData();
                if (activePage === 'jobs') renderJobs();
                if (updates.status && updates.status !== 'processing' && activePage !== 'jobs') {
                    const job = localData.jobs[jobIndex];
                    showNotification(`Trabalho ${updates.status === 'completed' ? 'Conclu√≠do' : 'Falhou'}`, `Seu trabalho "${job.question}" foi finalizado.`);
                }
            }
        }
        
        async function createMathJob(file) {
            if (!file) return;
            const job = createJob('math', `Exerc√≠cio: ${file.name}`);
            try {
                await updateJobProgress(job.id, { progress: 20 });
                const worker = await Tesseract.createWorker('por');
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                await updateJobProgress(job.id, { progress: 50 });
                const prompt = `Resolva o seguinte exerc√≠cio de matem√°tica. Forne√ßa uma resposta clara e em HTML. A pergunta √©: ${text}`;
                const answer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]);
                await updateJobProgress(job.id, { status: 'completed', progress: 100, answer, resultType: 'math' });
            } catch (error) {
                console.error("Job failed:", error);
                await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message });
            }
        }
        
        async function createExplainJob(text, fileName = 'texto colado') {
            if (!text || text.trim().length < 20) {
                showToast("O texto √© muito curto para ser explicado.", "error");
                return;
            }
            const job = createJob('explain', `Resumo de: ${fileName}`);
            try {
                await updateJobProgress(job.id, { progress: 50 });
                const prompt = `Resuma e explique os pontos principais do texto a seguir em um formato HTML claro e bem estruturado. Texto: "${text}"`;
                const answer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]);
                await updateJobProgress(job.id, { status: 'completed', progress: 100, answer, resultType: 'explain' });
            } catch (error) {
                console.error("Job failed:", error);
                await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message });
            }
        }

        async function createPdfJob(formData) {
            const job = createJob('pdf', `Documento sobre: ${formData.topic}`);
            try {
                await updateJobProgress(job.id, { progress: 50 });
                const prompt = `Crie um texto no estilo ${formData.style} com um tom ${formData.tone} para um p√∫blico de ${formData.audience} sobre o t√≥pico "${formData.topic}". O resultado deve ser um texto bem estruturado em HTML.`;
                const answer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]);
                await updateJobProgress(job.id, { status: 'completed', progress: 100, answer, resultType: 'pdf' });
            } catch (error) {
                console.error("Job failed:", error);
                await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message });
            }
        }

        async function createTranslateJob(text, targetLang) {
             if (!text || text.trim().length < 1) {
                showToast("Insira um texto para traduzir.", "error");
                return;
            }
            const job = createJob('translate', `Tradu√ß√£o: ${text.substring(0, 20)}...`);
            try {
                 await updateJobProgress(job.id, { progress: 50 });
                const prompt = `Traduza o seguinte texto para ${targetLang}. Retorne apenas a tradu√ß√£o. Texto: "${text}"`;
                const answer = await getAIResponse("openai/gpt-oss-20b", [{ role: "user", content: prompt }]);
                await updateJobProgress(job.id, { status: 'completed', progress: 100, answer: `<p>${answer}</p>`, resultType: 'translate' });
            } catch (error) {
                console.error("Job failed:", error);
                await updateJobProgress(job.id, { status: 'failed', progress: 100, error: error.message });
            }
        }
        
        async function handleJobActions(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const { action, jobId } = button.dataset;
            if (!action || !jobId) return;

            const job = localData.jobs.find(j => j.id === jobId);
            if (!job) return;

            if (action === 'toggle') {
                const resultDiv = document.getElementById(`job-result-${jobId}`);
                const isHidden = resultDiv.classList.toggle('hidden');
                button.textContent = isHidden ? 'Ver Resultado' : 'Ocultar Resultado';
            } else if (action === 'edit') {
                openPdfEditor(job);
            } else if (action === 'download') {
                downloadPdf(job.answer, job.question);
            }
        }

        function renderJobs() {
            const jobsList = document.getElementById('jobs-list');
            jobsList.innerHTML = '';
            if (localData.jobs.length === 0) {
                jobsList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum trabalho encontrado.</p>';
                return;
            }
            localData.jobs.forEach(job => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg shadow-sm overflow-hidden';
                let actionButtons = '';
                if (job.status === 'completed') {
                    actionButtons += `<button data-job-id="${job.id}" data-action="toggle" class="text-sm text-primary font-semibold">Ver Resultado</button>`;
                    if (job.resultType === 'pdf') {
                        actionButtons += `<button data-job-id="${job.id}" data-action="edit" class="ml-4 text-sm bg-secondary text-white font-semibold py-1 px-3 rounded-md">Editar</button>`;
                    }
                    actionButtons += `<button data-job-id="${job.id}" data-action="download" class="ml-4 text-sm bg-green-500 text-white font-semibold py-1 px-3 rounded-md">Baixar PDF</button>`;
                }
                const progressBar = job.status === 'processing' ? `<div class="w-full bg-gray-200 rounded-full h-2 mt-2"><div class="bg-primary h-2 rounded-full transition-all duration-300 animate-progress-bar-stripes" style="width: ${job.progress || 0}%"></div></div>` : '';
                const resultHTML = job.answer || (job.error || 'Sem detalhes.');
                
                el.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-gray-700 break-all">${job.question || 'Trabalho'}</p>
                        <span class="text-xs px-2 py-1 rounded-full whitespace-nowrap ml-2 ${job.status === 'completed' ? 'bg-green-100 text-green-700' : (job.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700')}">${job.status}</span>
                    </div>
                    ${progressBar}
                    <div class="mt-4 pt-4 border-t hidden" id="job-result-${job.id}">
                        <div class="bg-gray-50 p-4 rounded-lg prose prose-sm max-w-full break-words">${resultHTML}</div>
                    </div>
                    <div class="mt-4 text-right">${actionButtons}</div>`;
                jobsList.appendChild(el);
            });
        }
        
        // --- FUN√á√ïES DE NAVEGA√á√ÉO E UI ---
        function finishInitialLoad() { const loader = document.getElementById('initial-loading-overlay'); loader.classList.add('animate-fadeOut'); setTimeout(() => loader.remove(), 500); }
        function showScreen(elementId) { document.querySelectorAll('.screen').forEach(el => { if (el.id === elementId) { el.classList.remove('hidden', 'animate-fadeOut'); el.classList.add('animate-fadeIn'); } else if (!el.classList.contains('hidden')) { el.classList.add('animate-fadeOut'); setTimeout(() => el.classList.add('hidden'), 400); } }); }
        
        function navigateTo(pageId, params = {}) {
            if (activePage === pageId && pageId !== 'action') return;
            document.getElementById(`page-${activePage}`)?.classList.remove('active');
            
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) targetPage.classList.add('active');
            activePage = pageId;

            const backBtn = document.getElementById('backBtn');
            const navBar = document.querySelector('nav');
            const headerTitle = document.getElementById('header-title');

            const isHomePage = pageId === 'home';
            backBtn.classList.toggle('hidden', isHomePage);
            navBar.classList.toggle('hidden', !isHomePage && pageId !== 'jobs' && pageId !== 'chat');
            document.querySelector('.nav-btn.text-primary')?.classList.remove('text-primary');
            document.querySelector(`.nav-btn[data-target="${pageId}"]`)?.classList.add('text-primary');

            switch (pageId) {
                case 'home': headerTitle.textContent = "Cabula"; break;
                case 'jobs': headerTitle.textContent = "Meus Trabalhos"; renderJobs(); break;
                case 'chat': headerTitle.textContent = "Chat com Jinoca"; loadChatHistory(); initialViewportHeight = window.innerHeight; break;
                case 'action': renderActionPage(params.tool); break;
            }
        }
        
        function showToast(message, type = 'info') { const toast = document.createElement('div'); const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-gray-800'); toast.className = `fixed top-5 left-1/2 -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg text-sm z-[9999] shadow-lg animate-slideInUp`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.classList.add('animate-fadeOut'); toast.addEventListener('animationend', () => toast.remove()); }, 3000); }
        async function getAIResponse(model, messages) { const response = await fetch(API_URL_MAIN, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${atob(OBFUSCATED_KEY_MAIN)}` }, body: JSON.stringify({ model, messages, temperature: 1, max_tokens: 4096 }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const json = await response.json(); if (!json.choices || json.choices.length === 0) throw new Error("Invalid API response"); return json.choices[0].message.content; }
        function markdownToHtml(text) { if (!text) return ''; return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded-md text-sm"><code>$1</code></pre>').replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-sm rounded px-1 py-0.5">$1</code>').replace(/\n/g, '<br>'); }
        window.copyToClipboard = function(text) { navigator.clipboard.writeText(text).then(() => { showToast('Mensagem copiada!', 'success'); }).catch(err => { console.error('Falha ao copiar: ', err); showToast('Falha ao copiar!', 'error'); }); }
        
        function setupNavigation() { const navButtons = document.querySelectorAll('.nav-btn'); const icons = { home: `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>`, jobs: `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.5 2.25a2.25 2.25 0 012.25 2.25v1.506a2.25 2.25 0 01-1.125 1.957l-1.928.964A2.25 2.25 0 007.5 11.25v2.535A2.25 2.25 0 009.428 15.75l1.928.964A2.25 2.25 0 0112.5 18.75v1.506a2.25 2.25 0 01-2.25 2.25H4.5A2.25 2.25 0 012.25 20.25V4.5A2.25 2.25 0 014.5 2.25h5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12.5 6h5.25a2.25 2.25 0 012.25 2.25v1.5a2.25 2.25 0 01-2.25 2.25h-5.25V6zM12.5 15h5.25a2.25 2.25 0 012.25 2.25v1.5a2.25 2.25 0 01-2.25 2.25h-5.25V15z" /></svg>`, chat: `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72 3.72a1.125 1.125 0 01-1.59 0l-3.72-3.72a2.122 2.122 0 01-1.98-2.193v-4.286c0-.97.616-1.813 1.5-2.097m6.75 0a48.667 48.667 0 00-7.5 0" /></svg>` }; const filledIcons = { home: `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" /><path d="M12 5.432l8.159 8.159c.026.026.05.054.07.084v6.101a2.25 2.25 0 01-2.25 2.25H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.25a2.25 2.25 0 01-2.25-2.25v-6.101c.02-.03.044-.058.07-.084L12 5.432z" /></svg>`, jobs: `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5.625 3h12.75a3.375 3.375 0 013.375 3.375v14.25a3.375 3.375 0 01-3.375 3.375H5.625A3.375 3.375 0 012.25 20.625V6.375A3.375 3.375 0 015.625 3zM9.75 12a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5z" /><path d="M11.25 5.25a1.5 1.5 0 00-3 0v.75a.75.75 0 001.5 0V6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v.75a.75.75 0 001.5 0v-.75a1.5 1.5 0 00-3 0V5.25z" /></svg>`, chat: `<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.521 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97-1.033.153-2.14.26-3.28.326a.75.75 0 01-.33.89l-2.755 1.653a.75.75 0 01-1.12 0l-2.755-1.653a.75.75 0 01-.33-.89c-1.14-.066-2.247-.173-3.28-.326C1.87 16.26 1.5 14.53 1.5 12.58V6.56c0-1.946 1.37-3.678 3.348-3.79zM7.5 9a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V9.75A.75.75 0 017.5 9zm4.5 0a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75V9.75a.75.75 0 01.75-.75h.008zM15 9.75a.75.75 0 00-.75-.75h-.008a.75.75 0 00-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 00.75-.75V9.75z" clip-rule="evenodd" /></svg>` }; navButtons.forEach(button => { const targetId = button.dataset.target; button.querySelector('.icon-container').innerHTML = icons[targetId]; button.addEventListener('click', (e) => { const currentTarget = e.currentTarget; navButtons.forEach(btn => { btn.classList.remove('text-primary'); btn.classList.add('text-gray-400'); btn.querySelector('.icon-container').innerHTML = icons[btn.dataset.target]; }); currentTarget.classList.add('text-primary'); currentTarget.querySelector('.icon-container').innerHTML = filledIcons[currentTarget.dataset.target]; navigateTo(currentTarget.dataset.target); }); }); document.querySelector('.nav-btn[data-target="home"] .icon-container').innerHTML = filledIcons.home; }
        function showCustomConfirm(message, title = 'Confirmar A√ß√£o') { return new Promise((resolve) => { const modal = document.getElementById('custom-confirm-modal'); const msgEl = document.getElementById('custom-confirm-message'); const titleEl = document.getElementById('custom-confirm-title'); const okBtn = document.getElementById('custom-confirm-ok-btn'); const cancelBtn = document.getElementById('custom-confirm-cancel-btn'); msgEl.textContent = message; titleEl.textContent = title; modal.classList.remove('hidden'); const handleOk = () => { modal.classList.add('hidden'); resolve(true); cleanup(); }; const handleCancel = () => { modal.classList.add('hidden'); resolve(false); cleanup(); }; const cleanup = () => { okBtn.removeEventListener('click', handleOk); cancelBtn.removeEventListener('click', handleCancel); }; okBtn.addEventListener('click', handleOk); cancelBtn.addEventListener('click', handleCancel); }); }
        
        // --- NOTIFICA√á√ïES ---
        function requestNotificationPermission() { if ('Notification' in window && Notification.permission !== 'granted') { Notification.requestPermission(); } }
        function showNotification(title, body) { if ('Notification' in window && Notification.permission === 'granted') { new Notification(title, { body: body, icon: './icon.png' }); } }

        // --- RENDERIZA√á√ÉO DA P√ÅGINA DE A√á√ïES ---
        function renderActionPage(tool) {
            const pageContainer = document.getElementById('page-action');
            let content = '';
            let title = 'Funcionalidade';
            switch (tool) {
                case 'math':
                    title = 'Resolver Matem√°tica';
                    content = `<div class="page-content text-center"><h2 class="text-2xl font-bold text-gray-800 mb-2">Resolver exerc√≠cio</h2><p class="text-gray-600 mb-8">Envie uma foto da quest√£o de matem√°tica.</p><button id="action-math-photo" class="bg-primary text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition">Tirar ou escolher foto</button></div>`;
                    break;
                case 'explain':
                    title = 'Explicar Textos';
                    content = `<div class="page-content flex flex-col"><h2 class="text-2xl font-bold text-gray-800 mb-2">Explicar Texto ou PDF</h2><p class="text-gray-600 mb-6">Cole um texto ou envie um arquivo PDF para receber um resumo explicado.</p><textarea id="explain-textarea" class="w-full h-48 bg-gray-100 rounded-lg p-3 text-sm resize-none mb-4" placeholder="Cole seu texto aqui..."></textarea><div class="flex gap-4"><button id="action-explain-text" class="flex-1 bg-primary text-white font-bold py-3 px-4 rounded-lg">Explicar Texto Colado</button><button id="action-explain-pdf" class="flex-1 bg-secondary text-white font-bold py-3 px-4 rounded-lg">Enviar PDF</button></div></div>`;
                    break;
                case 'pdf':
                    title = 'Escritor de PDF';
                    content = `<div class="page-content"><h2 class="text-2xl font-bold text-gray-800 mb-2">Gerador de PDF Inteligente</h2><p class="text-sm text-gray-600 mb-6">Preencha os campos para que a IA crie o melhor texto para voc√™.</p><form id="pdf-generation-form" class="space-y-4"><div><label for="pdf-topic" class="block text-sm font-medium text-gray-700 mb-1">T√≥pico Principal</label><input type="text" id="pdf-topic" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ex: A hist√≥ria da computa√ß√£o" required></div><div><label for="pdf-tone" class="block text-sm font-medium text-gray-700 mb-1">Tom da Escrita</label><select id="pdf-tone" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm"><option>Formal</option><option>Informal</option><option>Acad√™mico</option><option>Criativo</option><option>T√©cnico</option></select></div><div><label for="pdf-style" class="block text-sm font-medium text-gray-700 mb-1">Estilo</label><select id="pdf-style" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm"><option>Dissertativo</option><option>Resumo</option><option>Artigo de opini√£o</option><option>Relat√≥rio</option></select></div><div><label for="pdf-audience" class="block text-sm font-medium text-gray-700 mb-1">P√∫blico-Alvo</label><input type="text" id="pdf-audience" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm" placeholder="Ex: Estudantes do ensino m√©dio"></div><div class="pt-4 flex gap-3"><button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Gerar Trabalho</button></div></form></div>`;
                    break;
                case 'translate':
                    title = 'Tradutor';
                    content = `<div class="page-content"><h2 class="text-2xl font-bold text-gray-800 mb-2">Tradutor Inteligente</h2><p class="text-gray-600 mb-6">Traduza textos para diversos idiomas.</p><textarea id="translate-textarea" class="w-full h-32 bg-gray-100 rounded-lg p-3 text-sm resize-none mb-4" placeholder="Digite o texto para traduzir..."></textarea><label for="translate-lang" class="block text-sm font-medium text-gray-700 mb-1">Traduzir para:</label><select id="translate-lang" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm mb-4"><option>Ingl√™s</option><option>Espanhol</option><option>Franc√™s</option><option>Portugu√™s</option></select><button id="action-translate-text" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Traduzir e Criar Trabalho</button></div>`;
                    break;
            }
            document.getElementById('header-title').textContent = title;
            pageContainer.innerHTML = content;
            setupActionPageListeners(tool);
        }

        // --- LISTENERS DA P√ÅGINA DE A√á√ïES ---
        function setupActionPageListeners(tool) {
            switch (tool) {
                case 'math':
                    document.getElementById('action-math-photo').addEventListener('click', () => { document.getElementById('generalFileInput').accept = 'image/*'; document.getElementById('generalFileInput').onchange = (e) => createMathJob(e.target.files[0]); document.getElementById('generalFileInput').click(); });
                    break;
                case 'explain':
                    document.getElementById('action-explain-text').addEventListener('click', () => { const text = document.getElementById('explain-textarea').value; createExplainJob(text); });
                    document.getElementById('action-explain-pdf').addEventListener('click', () => { document.getElementById('pdfUploadInput').click(); });
                    document.getElementById('pdfUploadInput').onchange = (e) => handlePdfUpload(e.target.files[0]);
                    break;
                case 'pdf':
                    document.getElementById('pdf-generation-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = {
                            topic: document.getElementById('pdf-topic').value,
                            tone: document.getElementById('pdf-tone').value,
                            style: document.getElementById('pdf-style').value,
                            audience: document.getElementById('pdf-audience').value,
                        };
                        createPdfJob(formData);
                    });
                    break;
                case 'translate':
                     document.getElementById('action-translate-text').addEventListener('click', () => { 
                         const text = document.getElementById('translate-textarea').value; 
                         const lang = document.getElementById('translate-lang').value;
                         createTranslateJob(text, lang); 
                     });
                    break;
            }
        }
        
        // --- FUN√á√ïES DE PDF ---
        async function handlePdfUpload(file) {
            if (!file) return;
            showToast('Extraindo texto do PDF...', 'info');
            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const pdfData = new Uint8Array(event.target.result);
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ');
                    }
                    showToast('Texto extra√≠do! Criando trabalho...', 'success');
                    createExplainJob(fullText, file.name);
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('PDF processing error:', error);
                showToast('Falha ao processar o PDF.', 'error');
            }
        }
        
        function openPdfEditor(job) {
            currentEditingJobId = job.id;
            document.getElementById('pdf-editor-content').innerHTML = job.answer;
            document.getElementById('pdf-editor-modal').classList.remove('hidden');
        }

        function saveAndClosePdfEditor() {
            if (!currentEditingJobId) return;
            const updatedContent = document.getElementById('pdf-editor-content').innerHTML;
            const jobIndex = localData.jobs.findIndex(j => j.id === currentEditingJobId);
            if (jobIndex !== -1) {
                localData.jobs[jobIndex].answer = updatedContent;
                saveLocalData();
                renderJobs();
                showToast('Altera√ß√µes salvas com sucesso!', 'success');
            }
            document.getElementById('pdf-editor-modal').classList.add('hidden');
            currentEditingJobId = null;
        }

        function downloadPdf(content, filename) {
            const element = document.createElement('div');
            element.innerHTML = content;
            const opt = {
                margin:       1,
                filename:     `${filename.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        }

    </script>
</body>
</html>
