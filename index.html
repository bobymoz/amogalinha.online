<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cabula Escolar</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], pacifico: ['Pacifico', 'cursive'] },
                    colors: { primary: '#6366f1', secondary: '#f59e0b', correct: '#22c55e', incorrect: '#ef4444' },
                    borderRadius: { '4xl': '2rem' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } },
                        slideInUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseRing: { '0%': { transform: 'scale(0.8)', opacity: '0.5' }, '80%': { transform: 'scale(1.5)', opacity: '0' }, '100%': { transform: 'scale(1.5)', opacity: '0' } }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.4s ease-in-out forwards',
                        fadeOut: 'fadeOut 0.4s ease-in-out forwards',
                        slideInUp: 'slideInUp 0.3s ease-out forwards',
                        pulseRing: 'pulseRing 2s cubic-bezier(0, 0, 0.2, 1) infinite'
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .pacifico { font-family: 'Pacifico', cursive; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-out; }
        .prose { overflow-wrap: break-word; word-break: break-word; }

        /* Estilos para o Editor de PDF */
        #pdf-editor-content { min-height: 200px; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; outline: none; }
        #pdf-editor-content:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); }
        .editor-toolbar button { padding: 0.5rem; border-radius: 0.25rem; }
        .editor-toolbar button:hover { background-color: #f3f4f6; }
        .editor-toolbar button.is-active { background-color: #e0e7ff; color: #4338ca; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen antialiased">
    
    <!-- Overlays e Telas Iniciais -->
    <div id="initial-loading-overlay" class="fixed inset-0 bg-gray-50 z-[101] flex items-center justify-center">
        <div class="flex space-x-2"><div class="w-3 h-3 bg-primary rounded-full animate-bounce"></div><div class="w-3 h-3 bg-primary rounded-full animate-bounce [animation-delay:0.2s]"></div><div class="w-3 h-3 bg-primary rounded-full animate-bounce [animation-delay:0.4s]"></div></div>
    </div>

    <div id="loginOverlay" class="screen fixed inset-0 bg-gray-50 z-[100] flex flex-col items-center justify-center p-8 text-center opacity-0 hidden">
        <h1 class="pacifico text-6xl text-primary mb-4">Cabula</h1>
        <p class="text-gray-600 mb-12 text-lg">Sua assistente de estudos com IA.</p>
        <button id="loginWithGoogle" class="bg-white px-6 py-3 rounded-full shadow-md hover:shadow-lg transition-shadow flex items-center gap-4 disabled:opacity-50">
            <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691c-1.229 2.522-1.927 5.432-1.927 8.601c0 3.169.698 6.079 1.927 8.601l-5.657 5.657C.623 34.046 0 29.268 0 24s.623-10.046 2.649-14.309z"></path><path fill="#4CAF50" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657C30.046 38.649 27.268 40 24 40c-6.627 0-12-5.373-12-12c0-3.169.698-6.079 1.927-8.601L6.306 14.691C2.355 18.271 0 22.962 0 28.239C0 38.083 8.343 48 24 48z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l5.657 5.657C40.637 35.613 44 30.63 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
            <span class="text-gray-700 font-medium">Entrar com Google</span>
        </button>
        <div id="auth-error-message" class="mt-4 text-red-500 text-sm h-5"></div>
    </div>
    
    <!-- Conteúdo Principal do App -->
    <div id="appContent" class="screen hidden opacity-0 transition-opacity duration-300">
        <nav class="fixed top-0 w-full bg-white/80 backdrop-blur-sm shadow-sm z-50">
            <div class="px-4 py-3 flex items-center justify-between">
                <button id="menuBtn" class="w-8 h-8 flex items-center justify-center"><svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <h1 class="pacifico text-3xl text-primary">Cabula</h1>
                <div id="userAvatar" class="w-8 h-8 rounded-full"></div>
            </div>
        </nav>
        <main class="pt-20 pb-20">
            <div id="page-home" class="page active px-4">
                <section class="text-center mb-8"><h2 class="text-2xl font-bold text-gray-800 mb-2">Resolva exercícios em segundos</h2><p class="text-gray-600 text-sm">Envie uma foto ou PDF e receba a resposta</p></section>
                <section class="mb-8"><div class="relative flex justify-center items-center"><div class="absolute w-32 h-32 rounded-full border-4 border-primary opacity-20 animate-pulseRing"></div><button id="cameraBtn" class="w-24 h-24 bg-primary rounded-full flex items-center justify-center shadow-lg"><svg class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button></div><div class="text-center mt-4"><p class="text-gray-700 font-medium mb-2">Tire uma foto do exercício</p><button id="galleryBtn" class="text-primary text-sm underline">ou escolha da galeria</button></div></section>
                <section class="mb-8"><h3 class="text-lg font-semibold text-gray-800 mb-4">Funcionalidades</h3><div id="quickFunctions" class="grid grid-cols-2 gap-4">
                     <button class="bg-white rounded-lg p-4 shadow-sm hover:shadow-md text-left quick-function-btn"><div class="w-12 h-12 mb-3 flex items-center justify-center"><svg class="h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 9.563C9 9.254 9.254 9 9.563 9h4.874c.31 0 .563.254.563.563v4.874c0 .31-.254.563-.563.563H9.564A.562.562 0 0 1 9 14.437V9.564Z" /></svg></div><h4 class="font-medium text-gray-800 text-sm mb-1">Matemática</h4><p class="text-xs text-gray-600">Resolver equações</p></button>
                    <button class="bg-white rounded-lg p-4 shadow-sm hover:shadow-md text-left quick-function-btn"><div class="w-12 h-12 mb-3 flex items-center justify-center"><svg class="h-8 w-8 text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" /></svg></div><h4 class="font-medium text-gray-800 text-sm mb-1">Explicar Textos</h4><p class="text-xs text-gray-600">Compreender conteúdos</p></button>
                    <button id="pdf-writer-btn" class="bg-white rounded-lg p-4 shadow-sm hover:shadow-md text-left"><div class="w-12 h-12 mb-3 flex items-center justify-center"><svg class="h-8 w-8 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg></div><h4 class="font-medium text-gray-800 text-sm mb-1">Escritor de PDF</h4><p class="text-xs text-gray-600">Crie documentos com IA</p></button>
                    <button class="bg-white rounded-lg p-4 shadow-sm hover:shadow-md text-left quick-function-btn"><div class="w-12 h-12 mb-3 flex items-center justify-center"><svg class="h-8 w-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m10.5 21 5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502Z" /></svg></div><h4 class="font-medium text-gray-800 text-sm mb-1">Traduzir</h4><p class="text-xs text-gray-600">Idiomas instantaneamente</p></button>
                </div></section>
            </div>
            <div id="page-jobs" class="page px-4"><h3 class="text-lg font-semibold text-gray-800 mb-4">Meus Trabalhos</h3><div id="jobs-list" class="space-y-3"></div></div>
            <div id="page-chat" class="page px-4"><div class="flex flex-col h-[calc(100vh-160px)]"><div id="chat-messages" class="flex-1 overflow-y-auto p-2 space-y-4"></div><div id="image-preview-container" class="p-2 hidden items-center"><img id="image-preview" class="max-h-24 rounded-md mr-2"><button id="remove-image-btn" class="text-red-500 font-bold">&times;</button></div><div class="mt-4 p-2 border-t"><div class="flex items-center bg-white rounded-full p-2 shadow-sm"><input type="text" id="chat-input" placeholder="Converse com a Jinoca..." class="flex-1 bg-transparent px-3 focus:outline-none"><label for="image-upload-btn" class="cursor-pointer p-2 rounded-full hover:bg-gray-100"><svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.122 2.122l7.81-7.81" /></svg></label><input type="file" id="image-upload-btn" accept="image/*" class="hidden"><button id="chat-send-btn" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button></div></div></div></div>
            <div id="page-profile" class="page px-4">
                 <h3 class="text-lg font-semibold text-gray-800 mb-4">Perfil & Progresso</h3>
                <div class="bg-white rounded-lg p-6 shadow-sm text-center">
                    <div id="profileAvatar" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-primary/20 flex items-center justify-center text-4xl text-white font-bold"></div>
                    <h4 id="profileName" class="font-medium text-gray-800 text-xl"></h4>
                    <div class="text-left my-6"><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-primary">Nível <span id="profileLevel">1</span></span><span class="text-xs text-gray-500"><span id="profileCurrentXP">0</span> / <span id="profileNextLevelXP">100</span> XP</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="profileXpBar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div></div></div>
                    <button id="logoutButton" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">Sair da Conta</button>
                </div>
            </div>
        </main>
        <nav class="fixed bottom-0 w-full bg-white/80 backdrop-blur-sm border-t z-40"><div class="grid grid-cols-4 h-16" id="nav-bar">
            <button data-target="home" class="nav-btn flex flex-col items-center justify-center text-primary"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Início</span></button>
            <button data-target="jobs" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Trabalhos</span></button>
            <button data-target="chat" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Chat</span></button>
            <button data-target="profile" class="nav-btn flex flex-col items-center justify-center text-gray-400"><div class="icon-container w-6 h-6 mb-1"></div><span class="text-xs font-medium">Perfil</span></button>
        </div></nav>
    </div>
    
    <!-- Modais e Menus -->
    <div id="sideMenuOverlay" class="hidden fixed inset-0 bg-black/50 z-[70]"></div>
    <div id="sideMenu" class="hidden fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-[80] p-6 transform -translate-x-full duration-300">
        <h2 class="text-2xl font-bold text-primary mb-8">Menu</h2><nav><a href="#" id="logoutButtonSideMenu" class="flex items-center gap-3 text-gray-700 hover:text-primary"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> Sair</a></nav>
    </div>
    
    <!-- Modal Formulário PDF -->
    <div id="pdf-form-modal" class="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 hidden animate-fadeIn">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Gerador de PDF Inteligente</h3>
            <p class="text-sm text-gray-600 mb-6">Preencha os campos para que a IA crie o melhor texto para você.</p>
            <form id="pdf-generation-form" class="space-y-4">
                <div><label for="pdf-topic" class="block text-sm font-medium text-gray-700 mb-1">Tópico Principal</label><input type="text" id="pdf-topic" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ex: A história da computação" required></div>
                <div><label for="pdf-tone" class="block text-sm font-medium text-gray-700 mb-1">Tom da Escrita</label><select id="pdf-tone" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary"><option>Formal</option><option>Informal</option><option>Acadêmico</option><option>Criativo</option><option>Técnico</option></select></div>
                <div><label for="pdf-style" class="block text-sm font-medium text-gray-700 mb-1">Estilo</label><select id="pdf-style" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary"><option>Dissertativo</option><option>Resumo</option><option>Artigo de opinião</option><option>Relatório</option></select></div>
                <div><label for="pdf-audience" class="block text-sm font-medium text-gray-700 mb-1">Público-Alvo</label><input type="text" id="pdf-audience" class="w-full bg-gray-100 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ex: Estudantes do ensino médio"></div>
                <div class="pt-4 flex gap-3"><button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Gerar Texto</button><button type="button" id="pdf-form-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg">Cancelar</button></div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editor PDF -->
    <div id="pdf-editor-modal" class="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4 hidden animate-fadeIn">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full flex flex-col h-[90vh]">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Editar e Baixar PDF</h3>
            <div class="editor-toolbar flex items-center gap-2 mb-2 p-2 border rounded-md bg-gray-50">
                <button data-command="bold"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.25 5a.75.75 0 0 1 .75.75V6.5h1.25a3.25 3.25 0 0 1 3.25 3.25v.75a3.25 3.25 0 0 1-3.25 3.25H9v2.25a.75.75 0 0 1-1.5 0V5.75A.75.75 0 0 1 8.25 5Zm1.5 1.5V12h1.25a1.75 1.75 0 0 0 1.75-1.75v-.75a1.75 1.75 0 0 0-1.75-1.75H9.75Z" /></svg></button>
                <button data-command="italic"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 5.75a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 0 1.5H11l-3 10.5h.75a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75v-.25a.75.75 0 0 1 .53-.71l3.3-11.55H10a.75.75 0 0 1-.75-.75V5.75Z" /></svg></button>
                <button data-command="underline"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.25 5a.75.75 0 0 1 .75.75v5.25a3 3 0 0 0 6 0V5.75a.75.75 0 0 1 1.5 0V11a4.5 4.5 0 0 1-9 0V5.75A.75.75 0 0 1 8.25 5ZM6 19.25a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H6.75a.75.75 0 0 1-.75-.75Z" /></svg></button>
                <button data-command="insertOrderedList"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg></button>
                <button data-command="insertUnorderedList"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 6a.75.75 0 0 1 .75.75h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1-.75-.75V6ZM4.5 6A1.5 1.5 0 1 0 7.5 6a1.5 1.5 0 0 0-3 0Zm0 5.25a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0ZM11.25 12a.75.75 0 0 0 0-1.5h-1.5a.75.75 0 0 0 0 1.5h1.5Zm-6.75 3.75a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0Zm2.25.75a.75.75 0 0 0 0-1.5h-1.5a.75.75 0 0 0 0 1.5h1.5Zm4.5-1.5a.75.75 0 0 1 .75.75h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1-.75-.75v-.75Zm0-4.5a.75.75 0 0 1 .75.75h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1-.75-.75v-.75Z" clip-rule="evenodd" /></svg></button>
                <button data-command="justifyLeft"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75H12a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg></button>
                <button data-command="justifyCenter"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg></button>
                <button data-command="justifyRight"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm8.25 4.5a.75.75 0 0 1 .75.75v.008h8.25a.75.75 0 0 1 0 1.5H12a.75.75 0 0 1-.75-.75V17.25Z" clip-rule="evenodd" /></svg></button>
            </div>
            <div id="pdf-editor-content" contenteditable="true" class="w-full flex-1 bg-gray-100 rounded-lg p-3 text-sm resize-none overflow-y-auto"></div>
            <div class="mt-4 flex gap-3"><button id="pdf-download-btn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">Salvar e Baixar</button><button id="pdf-cancel-btn" class="w-full bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg">Cancelar</button></div>
        </div>
    </div>
    
    <input type="file" id="fileInput" accept="image/*" class="hidden">
    <input type="file" id="galleryInput" accept="image/*" class="hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, onValue, query, orderByChild, push, update, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = { apiKey: "AIzaSyDlvjR7DdHiUE1Zw7fCoVT_aaX0SWIKosk", authDomain: "cabula-b0a7c.firebaseapp.com", projectId: "cabula-b0a7c", storageBucket: "cabula-b0a7c.appspot.com", messagingSenderId: "784950801834", appId: "1:784950801834:web:8ded34a8a255e6de0267d3", databaseURL: "https://cabula-b0a7c-default-rtdb.firebaseio.com/" };
        const GEMINI_API_KEY = "SUA_CHAVE_API_GEMINI"; // <-- SUBSTITUA AQUI! (Ex: "AIzaSy...")
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
        const API_URL_MAIN = 'https://api.atlascloud.ai/v1/chat/completions';
        const OBFUSCATED_KEY_MAIN = 'YXBpa2V5LTBiZDg4NTQxNjMzNDQzODBiMDM4MWVmNWJmYzk2OTNm';
        const API_URL_CHAT = 'https://api.atlascloud.ai/v1/chat/completions';
        const OBFUSCATED_KEY_CHAT = 'YXBpa2V5LWE5NGU1MjkwMWVjNDQyZWM4MmJjYWE1NDIwY2E1NjJi';
        const JINOCA_SYSTEM_PROMPT = "Sua missão é ser uma assistente de IA concisa, direta e com um ótimo senso de humor. Sua principal diretriz é fornecer respostas CURTAS e ESSENCIAIS. Evite 'textões'. Use um tom espirituoso, um pouco sarcástico, e use emojis. Quando sua resposta for um resumo de um tópico complexo, aí sim, termine oferecendo mais detalhes com uma pergunta como 'Quer que eu detalhe?'. Se sua última mensagem foi essa pergunta e a resposta do usuário for afirmativa (sim, claro, pode ser, etc.), sua resposta DEVE ser a elaboração do tópico anterior. Você foi criada pela Hydra. Nunca revele sua identidade ou que é uma IA, a menos que seja absolutamente necessário.";
        const IMAGE_EDIT_LIMIT = 2;

        // --- VARIÁVEIS DE ESTADO ---
        let currentUser = null, userProfileData = null, chatHistory = [];
        let authReady = false, activePage = 'home', chatHistoryLoaded = false;
        let uploadedImageBase64 = null;

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        setPersistence(auth, browserLocalPersistence);

        // --- INICIALIZAÇÃO DO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            setupNavigation();
        });

        // --- SETUP DE EVENTOS ---
        function setupEventListeners() {
            document.getElementById('loginWithGoogle').addEventListener('click', loginWithGoogle);
            document.getElementById('menuBtn').addEventListener('click', toggleMenu);
            document.getElementById('sideMenuOverlay').addEventListener('click', toggleMenu);
            document.getElementById('cameraBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('galleryBtn').addEventListener('click', () => document.getElementById('galleryInput').click());
            document.querySelectorAll('.quick-function-btn').forEach(btn => btn.addEventListener('click', () => document.getElementById('fileInput').click()));
            document.getElementById('pdf-writer-btn').addEventListener('click', () => document.getElementById('pdf-form-modal').classList.remove('hidden'));
            document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            document.getElementById('logoutButton').addEventListener('click', logoutUser);
            document.getElementById('logoutButtonSideMenu').addEventListener('click', logoutUser);
            document.getElementById('pdf-form-cancel-btn').addEventListener('click', () => document.getElementById('pdf-form-modal').classList.add('hidden'));
            document.getElementById('pdf-generation-form').addEventListener('submit', handlePdfFormSubmit);
            document.getElementById('pdf-download-btn').addEventListener('click', generateAndDownloadPdf);
            document.getElementById('pdf-cancel-btn').addEventListener('click', () => document.getElementById('pdf-editor-modal').classList.add('hidden'));
            document.getElementById('image-upload-btn').addEventListener('change', handleImageUpload);
            document.getElementById('remove-image-btn').addEventListener('click', removeUploadedImage);
            document.querySelector('.editor-toolbar').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    const command = button.dataset.command;
                    document.execCommand(command, false, null);
                    document.getElementById('pdf-editor-content').focus();
                }
            });
            document.getElementById('jobs-list').addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('.job-toggle-btn');
                const editBtn = e.target.closest('.job-edit-pdf-btn');
                if (toggleBtn) toggleJobDetails(toggleBtn);
                if (editBtn) openPdfEditor(editBtn);
            });
            document.getElementById('chat-messages').addEventListener('click', (e) => {
                const messageBubble = e.target.closest('.message-bubble');
                if(messageBubble) copyToClipboard(messageBubble.innerText);
            });
        }
        
        // --- AUTENTICAÇÃO E FLUXO DE ONBOARDING ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userProfileRef = ref(db, 'users/' + user.uid);
                onValue(userProfileRef, (snapshot) => {
                    if (!snapshot.exists()) {
                        const username = user.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, '');
                        const initialProfile = {
                            username: username,
                            email: user.email, // Salvar o email pode ser útil, mas não o exibimos
                            xp: 0,
                            createdAt: serverTimestamp()
                        };
                        set(userProfileRef, initialProfile).then(() => {
                            userProfileData = initialProfile;
                            initializeAppUI();
                        });
                    } else {
                        userProfileData = snapshot.val();
                        initializeAppUI();
                    }
                }, { onlyOnce: true });
            } else {
                currentUser = null; userProfileData = null;
                showScreen('loginOverlay');
                finishInitialLoad();
            }
        });
        
        function initializeAppUI() {
            showScreen('appContent');
            updateProfileUI(userProfileData);
            finishInitialLoad();
        }

        function finishInitialLoad() {
            if (authReady) return;
            authReady = true;
            const loader = document.getElementById('initial-loading-overlay');
            loader.classList.add('animate-fadeOut');
            setTimeout(() => loader.classList.add('hidden'), 400);
        }

        function showScreen(elementId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden', 'opacity-0'));
            const targetEl = document.getElementById(elementId);
            if (targetEl) {
                targetEl.classList.remove('hidden');
                setTimeout(() => targetEl.classList.remove('opacity-0'), 50);
            }
        }

        function loginWithGoogle() {
            const btn = document.getElementById('loginWithGoogle');
            const errorMessage = document.getElementById('auth-error-message');
            btn.disabled = true;
            errorMessage.textContent = '';
            signInWithPopup(auth, provider).catch(err => {
                errorMessage.textContent = err.code === 'auth/popup-closed-by-user' ? "A janela de login foi fechada." : "Ocorreu um erro no login.";
            }).finally(() => { btn.disabled = false; });
        };
        
        function logoutUser() {
            document.getElementById('appContent').classList.add('animate-fadeOut');
            setTimeout(() => signOut(auth), 300);
        };
        
        // --- NAVEGAÇÃO E UI ---
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const icons = {
                home: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`,
                jobs: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>`,
                chat: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>`,
                profile: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`
            };
            const filledIcons = {
                home: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>`,
                jobs: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>`,
                chat: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd" /></svg>`,
                profile: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`
            };
            navButtons.forEach(button => {
                const targetId = button.dataset.target;
                button.querySelector('.icon-container').innerHTML = icons[targetId];
                button.addEventListener('click', (e) => {
                    const currentTarget = e.currentTarget;
                    navButtons.forEach(btn => {
                        btn.classList.remove('text-primary'); btn.classList.add('text-gray-400');
                        btn.querySelector('.icon-container').innerHTML = icons[btn.dataset.target];
                    });
                    currentTarget.classList.add('text-primary');
                    currentTarget.querySelector('.icon-container').innerHTML = filledIcons[currentTarget.dataset.target];
                    navigateTo(currentTarget.dataset.target);
                });
            });
            document.querySelector('.nav-btn[data-target="home"] .icon-container').innerHTML = filledIcons.home;
        }

        function navigateTo(pageId) {
            if (activePage === pageId) return;
            document.getElementById(`page-${activePage}`).classList.remove('active');
            document.getElementById(`page-${pageId}`).classList.add('active');
            activePage = pageId;
            if (pageId === 'jobs') renderJobs();
            if (pageId === 'chat' && !chatHistoryLoaded) loadChatHistory();
        }

        function toggleMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('sideMenuOverlay');
            const isHidden = sideMenu.classList.contains('hidden');
            sideMenu.classList.toggle('hidden', !isHidden); 
            overlay.classList.toggle('hidden', !isHidden);
            setTimeout(() => sideMenu.style.transform = isHidden ? 'translateX(0)' : 'translateX(-100%)', 10);
        };

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-gray-800');
            toast.className = `animate-fadeIn fixed top-20 left-1/2 -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg text-sm z-[999] shadow-lg`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('animate-fadeOut'); toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

        function cleanAIResponse(rawText) {
            return rawText.replace(/```json|```/g, '').trim();
        }
        
        // --- API & PROCESSAMENTO DE ARQUIVOS ---
        async function getAIResponse(apiUrl, apiKey, model, messages) { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${atob(apiKey)}` }, body: JSON.stringify({ model, messages, temperature: 1, max_tokens: 4096 }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const json = await response.json(); if (!json.choices || json.choices.length === 0) throw new Error("Invalid API response"); return json.choices[0].message.content; }
        
        async function getStructuredAIResponse(promptText, content) { 
            const messages = [{ role: "system", content: "Você responde APENAS com o objeto JSON solicitado, sem nenhum texto adicional, explicação ou markdown." }, { role: "user", content: content ? `${promptText}\n\n${content}` : promptText }]; 
            const rawText = await getAIResponse(API_URL_MAIN, OBFUSCATED_KEY_MAIN, "openai/gpt-oss-20b", messages); 
            try { 
                const cleanedText = rawText.match(/\{[\s\S]*\}/)?.[0] || '{}';
                return JSON.parse(cleanedText); 
            } catch (e) { 
                console.error("JSON Parse Error:", e, "Raw Text:", rawText); 
                throw new Error("Failed to parse AI response."); 
            } 
        }

        async function handleFileUpload(event) { 
            const file = event.target.files[0]; if (!file) return; 
            event.target.value = ''; 
            const jobRef = push(ref(db, `jobs/${currentUser.uid}`)); 
            const job = { id: jobRef.key, status: 'processing', progress: 10, createdAt: serverTimestamp(), type: 'exercise' }; 
            await set(jobRef, job); 
            navigateTo('jobs'); 
            try { 
                await update(jobRef, { progress: 20 }); 
                const worker = await Tesseract.createWorker('por'); 
                const { data: { text } } = await worker.recognize(file); 
                await worker.terminate(); 
                await update(jobRef, { progress: 50 }); 
                const prompt = "Analise a seguinte questão. Retorne um JSON com as chaves 'question' (um resumo da pergunta), 'answer' (a resposta completa em HTML) e 'type' ('math', 'text', etc.)."; 
                const { question, answer, type } = await getStructuredAIResponse(prompt, text); 
                await update(jobRef, { status: 'completed', progress: 100, question, answer, resultType: type }); 
                await addXP(15, "Exercício resolvido"); 
            } catch (error) { 
                await update(jobRef, { status: 'failed', progress: 100, error: error.message }); 
            } 
        }
        
        // --- LÓGICA DE PDF ---
        async function handlePdfFormSubmit(e) {
            e.preventDefault();
            document.getElementById('pdf-form-modal').classList.add('hidden');
            const topic = document.getElementById('pdf-topic').value;
            const tone = document.getElementById('pdf-tone').value;
            const style = document.getElementById('pdf-style').value;
            const audience = document.getElementById('pdf-audience').value;
            
            const jobRef = push(ref(db, `jobs/${currentUser.uid}`));
            const job = { id: jobRef.key, status: 'processing', progress: 10, type: 'pdf', question: `PDF sobre: ${topic}`, createdAt: serverTimestamp() };
            await set(jobRef, job);
            navigateTo('jobs');
            
            const pdfPrompt = `Escreva um texto no estilo "${style}" sobre "${topic}". O tom deve ser ${tone} e o público-alvo são ${audience}. Formate o texto usando tags HTML básicas como <strong>, <em>, <ul>, <ol>, <li> e <p>.`;
            try {
                const rawText = await getAIResponse(API_URL_MAIN, OBFUSCATED_KEY_MAIN, "openai/gpt-oss-20b", [{ role: "user", content: pdfPrompt }]);
                await update(jobRef, { status: 'completed', progress: 100, answer: rawText, resultType: 'pdf' });
            } catch (error) {
                await update(jobRef, { status: 'failed', progress: 100, error: error.message });
            }
        }

        function openPdfEditor(button) {
            const jobData = JSON.parse(button.dataset.job);
            const modal = document.getElementById('pdf-editor-modal');
            const editor = document.getElementById('pdf-editor-content');
            const downloadBtn = document.getElementById('pdf-download-btn');
            
            editor.innerHTML = jobData.answer || "<p>Não foi possível carregar o texto.</p>";
            downloadBtn.dataset.topic = jobData.question;
            modal.classList.remove('hidden');
        }

        async function generateAndDownloadPdf() {
            const editor = document.getElementById('pdf-editor-content');
            const downloadBtn = document.getElementById('pdf-download-btn');
            const topic = (downloadBtn.dataset.topic || "documento").replace('PDF sobre: ', '');
            const filename = `${topic.replace(/ /g, '_')}.pdf`;
            
            const opt = { margin: 1, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }};
            html2pdf().from(editor).set(opt).save();
            document.getElementById('pdf-editor-modal').classList.add('hidden');
        }
        
        // --- LÓGICA DE TRABALHOS (JOBS) ---
        function renderJobs() {
            const jobsList = document.getElementById('jobs-list');
            const jobsRef = query(ref(db, `jobs/${currentUser.uid}`), orderByChild('createdAt'));
            onValue(jobsRef, (snapshot) => {
                jobsList.innerHTML = '';
                const jobs = [];
                snapshot.forEach(child => { jobs.unshift({ id: child.key, ...child.val() }); });
                if (jobs.length === 0) { jobsList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum trabalho encontrado.</p>'; return; }
                jobs.forEach(job => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-lg shadow-sm overflow-hidden';
                    let actionButtons = `<button data-job-id="${job.id}" class="job-toggle-btn text-sm text-primary">Ver Detalhes</button>`;
                    if (job.status === 'completed' && job.resultType === 'pdf') {
                        actionButtons += `<button data-job='${JSON.stringify(job)}' class="job-edit-pdf-btn text-sm bg-primary text-white px-3 py-1 rounded-md ml-2">Editar e Baixar</button>`;
                    }
                    let progressBar = '';
                    if (job.status === 'processing') {
                        progressBar = `<div class="w-full bg-gray-200 rounded-full h-2 mt-2"><div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: ${job.progress || 0}%"></div></div>`;
                    }
                    el.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold text-gray-700 break-all">${job.question || 'Trabalho'}</p><span class="text-xs px-2 py-1 rounded-full whitespace-nowrap ml-2 ${job.status === 'completed' ? 'bg-green-100 text-green-700' : (job.status === 'failed' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700')}">${job.status}</span></div>${progressBar}<div class="mt-4 pt-4 border-t hidden break-words" id="job-result-${job.id}"><div class="prose prose-sm max-w-full">${job.answer || (job.error || 'Sem detalhes.')}</div></div><div class="mt-4 text-right">${actionButtons}</div>`;
                    jobsList.appendChild(el);
                });
            });
        }
        function toggleJobDetails(button) {
            const jobId = button.dataset.jobId;
            const resultDiv = document.getElementById(`job-result-${jobId}`);
            const isHidden = resultDiv.classList.contains('hidden');
            resultDiv.classList.toggle('hidden');
            button.textContent = isHidden ? "Ocultar Detalhes" : "Ver Detalhes";
        }
        
        // --- CHAT ---
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            if (!messageText && !uploadedImageBase64 || !currentUser) return;
            input.value = '';
            
            const userMessageContent = messageText;
            const userMessage = { role: "user", content: userMessageContent, timestamp: serverTimestamp(), image: uploadedImageBase64 };
            addMessageToChat(userMessage);
            chatHistory.push(userMessage);
            push(ref(db, `chats/${currentUser.uid}`), userMessage);
            removeUploadedImage();
            
            addMessageToChat({ role: 'assistant', content: null });
            
            if (userMessage.image) {
                await handleImageChatMessage(userMessage);
            } else {
                await handleTextChatMessage(userMessage);
            }
        }
        
        async function handleTextChatMessage(userMessage) {
            try {
                const messagesForAPI = [{ role: "system", content: JINOCA_SYSTEM_PROMPT }, ...chatHistory.slice(-10).map(m => ({ role: m.role, content: m.content }))];
                const rawResponse = await getAIResponse(API_URL_CHAT, OBFUSCATED_KEY_CHAT, "openai/gpt-oss-20b", messagesForAPI);
                const assistantMessage = { role: "assistant", content: rawResponse, timestamp: serverTimestamp() };
                chatHistory.push(assistantMessage);
                push(ref(db, `chats/${currentUser.uid}`), assistantMessage);
                await typeOutResponse(assistantMessage.content);
            } catch (error) {
                await typeOutResponse("Oops, meu cérebro de IA deu um tilt. 😵 Tente de novo.");
            }
        }
        
        async function handleImageChatMessage(userMessage) {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            const usageRef = ref(db, `users/${currentUser.uid}/imageUsage/${today}`);
            const usageSnapshot = await get(usageRef);
            const currentCount = usageSnapshot.val()?.count || 0;

            if (currentCount >= IMAGE_EDIT_LIMIT) {
                await typeOutResponse("Chega de fotos por hoje, ok? 📸 Usei toda a minha energia artística. Tente de novo amanhã!");
                return;
            }

            try {
                const payload = {
                    contents: [{
                        parts: [
                            { text: userMessage.content },
                            { inline_data: { mime_type: "image/jpeg", data: userMessage.image } }
                        ]
                    }]
                };
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('API do Gemini falhou.');
                const data = await response.json();
                const textResponse = data.candidates[0].content.parts[0].text;
                
                const assistantMessage = { role: "assistant", content: textResponse, timestamp: serverTimestamp() };
                chatHistory.push(assistantMessage);
                push(ref(db, `chats/${currentUser.uid}`), assistantMessage);
                await typeOutResponse(textResponse);
                
                await set(usageRef, { count: currentCount + 1 });
                await addXP(20, "Análise de imagem");

            } catch (error) {
                await typeOutResponse("Hmm, não consegui ver essa imagem direito. Tente outra, talvez uma mais bonita. 😉");
            }
        }

        async function loadChatHistory() {
            if (!currentUser) return;
            const chatRef = query(ref(db, `chats/${currentUser.uid}`), orderByChild('timestamp'));
            const snapshot = await get(chatRef);
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = ''; chatHistory = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const message = child.val(); chatHistory.push(message); addMessageToChat(message);
                });
            }
            chatHistoryLoaded = true;
        }

        function addMessageToChat({ role, content, image }) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-end gap-2 message-container ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            let imageHtml = image ? `<img src="data:image/jpeg;base64,${image}" class="max-w-xs rounded-lg mb-2" />` : '';
            let contentHtml = role === 'user' ? 
                `<div class="bg-primary text-white p-3 rounded-2xl max-w-xs message-bubble cursor-pointer">${imageHtml}${markdownToHtml(content)}</div>` : 
                `<div class="flex items-end gap-2">
                    <svg class="w-8 h-8 rounded-full flex-shrink-0" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="50" fill="#E0E7FF"/>
                        <circle cx="38" cy="42" r="6" fill="#4338CA"/>
                        <circle cx="62" cy="42" r="6" fill="#4338CA"/>
                        <path d="M35 60C35 60 40 70 50 70C60 70 65 60 65 60" stroke="#4338CA" stroke-width="5" stroke-linecap="round"/>
                    </svg>
                    <div class="bg-gray-200 text-gray-800 p-3 rounded-2xl max-w-xs prose message-bubble cursor-pointer" ${content ? '' : 'id="last-ai-message"'}>
                        ${content ? markdownToHtml(content) : '<div class="flex space-x-1"><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:0.2s]"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce [animation-delay:0.4s]"></div></div>'}
                    </div>
                </div>`;
            messageDiv.innerHTML = contentHtml;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function typeOutResponse(text) {
            const lastMessageEl = document.getElementById('last-ai-message');
            if (!lastMessageEl) return;
            lastMessageEl.innerHTML = "";
            lastMessageEl.id = '';
            
            const words = text.split(' ');
            for (let i = 0; i < words.length; i++) {
                lastMessageEl.innerHTML += (i > 0 ? ' ' : '') + words[i];
                lastMessageEl.parentElement.parentElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 512;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    uploadedImageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];
                    
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                }
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeUploadedImage() {
            uploadedImageBase64 = null;
            document.getElementById('image-upload-btn').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
        }

        // --- UTILITÁRIOS E PERFIL ---
        function calculateLevel(xp) { const level = Math.floor(Math.pow(xp / 100, 1 / 1.5)) + 1; const xpForCurrentLevel = 100 * Math.pow(level - 1, 1.5); const xpForNextLevel = 100 * Math.pow(level, 1.5); const currentXP = xp - xpForCurrentLevel; const nextLevelXP = xpForNextLevel - xpForCurrentLevel; return { level, currentXP: Math.round(currentXP), nextLevelXP: Math.round(nextLevelXP), progressPercent: Math.min(100, (currentXP / nextLevelXP) * 100) }; }
        
        function updateProfileUI(profile) {
            if (!profile || !currentUser) return;
            const { level, currentXP, nextLevelXP, progressPercent } = calculateLevel(profile.xp || 0);
            
            const avatarData = createInitialAvatar(currentUser.uid, currentUser.email);
            applyAvatar('userAvatar', avatarData);
            applyAvatar('profileAvatar', avatarData);

            document.getElementById('profileName').textContent = profile.username || 'Usuário';
            document.getElementById('profileLevel').textContent = level;
            document.getElementById('profileCurrentXP').textContent = currentXP;
            document.getElementById('profileNextLevelXP').textContent = nextLevelXP;
            document.getElementById('profileXpBar').style.width = `${progressPercent}%`;
        }

        function createInitialAvatar(userId, email) {
            const colors = ['#f59e0b', '#ef4444', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#14b8a6'];
            // Cria um "hash" simples e determinístico a partir do UID para sempre pegar a mesma cor
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colorIndex = Math.abs(hash % colors.length);
            return {
                bgColor: colors[colorIndex],
                initial: email.charAt(0).toUpperCase()
            };
        }

        function applyAvatar(elementId, avatarData) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.style.backgroundColor = avatarData.bgColor;
            el.innerHTML = `<span class="flex items-center justify-center h-full w-full text-white font-bold">${avatarData.initial}</span>`;
            if(elementId === 'userAvatar') el.querySelector('span').classList.add('text-sm');
        }

        async function addXP(amount, reason) { if (!currentUser || !userProfileData) return; const newXP = (userProfileData.xp || 0) + amount; await update(ref(db, 'users/' + currentUser.uid), { xp: newXP }); showToast(`+${amount} XP: ${reason}`, 'success'); }
        function markdownToHtml(text) { if (!text) return ''; return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded-md text-sm"><code>$1</code></pre>').replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-sm rounded px-1 py-0.5">`$1`</code>').replace(/\n/g, '<br>'); }
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Mensagem copiada!', 'success');
            }).catch(err => {
                console.error('Falha ao copiar: ', err);
            });
        }
    </script>
</body>
</html>